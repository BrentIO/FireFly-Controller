name: Build Firmware

on: workflow_dispatch

env:
  VERSION_arduino_cli: 0.35.3
  VERSION_ESP_Core: 2.0.11
  VERSION_Adafruit_BusIO: 1.14.1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: $VERSION_arduino_cli

      - name: Initialize the installation
        run: arduino-cli config init

      - name: Add the ESP32 board manager packages
        run: arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      - name: Update the core index
        run: arduino-cli core update-index

      - name: Install ESP32 core
        run: arduino-cli core install esp32:esp32@$VERSION_ESP_Core

      - name: Create symlink for boards.local.txt
        run: |
          ARDUINO_DIR=`arduino-cli config dump --format json | jq -r .directories.data`
          ln -s ${{ github.workspace }}/boards.local.txt ${ARDUINO_DIR}/packages/esp32/hardware/esp32/$VERSION_ESP_Core/boards.local.txt
          cat ${ARDUINO_DIR}/packages/esp32/hardware/esp32/$VERSION_ESP_Core/boards.local.txt

      - name: Install libraries
        run: |
          arduino-cli lib install --git-url https://github.com/adafruit/Adafruit_BusIO.git#$VERSION_Adafruit_BusIO

      - name: Print Libraries
        run: arduino-cli lib list
