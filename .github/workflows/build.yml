name: ðŸ› ï¸ Build Firmware

on: workflow_dispatch

env:
  VERSION_ESP_Core: 2.0.11
  ARTIFACT_ROOT: /home/runner/artifacts

jobs:

  ConfigureAndBuild:
    name: Build all firmware
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        application:
          #- Controller
          - Hardware-Registration-and-Configuration
          
        product_hex:
          - "0x08062305"
          - "0x32322304"
          - "0x08062505"
          - "0x32322505"

        include:
          - product_hex: "0x08062305"
            name: FFC0806-2305
            partition_size_config: "0x80000"
            partition_size_www: "0x2E0000"

          - product_hex: "0x32322304"
            name: FFC3232-2304
            partition_size_config: "0x80000"
            partition_size_www: "0x2E0000"

          - product_hex: "0x08062505"
            name: FFC0806-2505
            partition_size_config: "0x80000"
            partition_size_www: "0x2E0000"
            
          - product_hex: "0x32322505"
            name: FFC3232-2505
            partition_size_config: "0x80000"
            partition_size_www: "0x2E0000"

    steps:
      - name: Set and Adjust Build Variables
        run: |
          COMMIT_HASH=${GITHUB_SHA::7}
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV

          BRANCH=$GITHUB_REF_NAME
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
              
      - name: Echo Tag or Branch Name and Commit Hash
        run: |
          echo "BRANCH: ${{ env.BRANCH }}"
          echo "COMMIT_HASH: ${{ env.COMMIT_HASH }}"
          echo "ARTIFACT_ROOT: ${{ env.ARTIFACT_ROOT }}"

      - name: Set VERSION based on tag or branch
        run: |
          if [ "$GITHUB_REF_TYPE" = "tag" ]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            echo "VERSION=DEBUG" >> $GITHUB_ENV
          fi

      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Arduino CLI
        if: ${{ !env.ACT }}
        uses: arduino/setup-arduino-cli@v2
        with:
          version: 0.35.3

      - name: Initialize the Arduino CLI Installation
        if: ${{ !env.ACT }}
        run: arduino-cli config init

      - name: Add the ESP32 Board Manager Packages to Arduino CLI
        if: ${{ !env.ACT }}
        run: arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      - name: Update CLI the Core Index
        if: ${{ !env.ACT }}
        run: arduino-cli core update-index

      - name: Install ESP32 Core
        if: ${{ !env.ACT }}
        run: arduino-cli core install esp32:esp32@$VERSION_ESP_Core

      - name: Create symlink for boards.local.txt
        run: |
          ARDUINO_DIR=$(arduino-cli config dump --format json | jq -r .directories.data)
          ln -s ${{ github.workspace }}/boards.local.txt ${ARDUINO_DIR}/packages/esp32/hardware/esp32/$VERSION_ESP_Core/boards.local.txt

      - name: Enable Unsafe Installation Flag to Enable Git Installs
        run: arduino-cli config set library.enable_unsafe_install true

      - name: Install Required Libraries at Specified Revisions
        if: ${{ !env.ACT }}
        run: |
          arduino-cli lib install --git-url https://github.com/adafruit/Adafruit_BusIO.git#1.14.1
          arduino-cli lib install --git-url https://github.com/adafruit/Adafruit-GFX-Library.git#1.11.5
          arduino-cli lib install --git-url https://github.com/adafruit/Adafruit_SSD1306.git#2.5.7
          arduino-cli lib install --git-url https://github.com/bblanchon/ArduinoJson.git#v6.21.5
          arduino-cli lib install --git-url https://github.com/bblanchon/ArduinoStreamUtils.git#v1.9.0
          arduino-cli lib install --git-url https://github.com/BrentIO/AsyncTCP.git#2024.2.1
          arduino-cli lib install --git-url https://github.com/BrentIO/AsyncWebServer_ESP32_W5500.git#2025.5.2
          arduino-cli lib install --git-url https://github.com/BrentIO/ESPAsyncWebServer.git#2024.7.1
          arduino-cli lib install --git-url https://github.com/BrentIO/esp32FOTA.git#2025.4.1
          arduino-cli lib install --git-url https://github.com/BrentIO/PCA95x5.git#2023.10.2
          arduino-cli lib install --git-url https://github.com/BrentIO/PCT2075.git#2023.10.3
          arduino-cli lib install --git-url https://github.com/BrentIO/pubsubclient.git#2025.4.1
          arduino-cli lib install --git-url https://github.com/arduino-libraries/Ethernet.git#2.0.2
          arduino-cli lib install --git-url https://github.com/RobTillaart/I2C_EEPROM.git#1.7.1
          arduino-cli lib install --git-url https://github.com/ivanseidel/LinkedList.git#v1.3.3
          arduino-cli lib install --git-url https://github.com/arduino-libraries/NTPClient.git#3.2.1
          arduino-cli lib install --git-url https://github.com/RobTillaart/PCA9685_RT.git#0.4.1
          arduino-cli lib install --git-url https://github.com/nickgammon/Regexp.git#0.1.1

      - name: Create Output Directory
        run: mkdir -p "${{ env.ARTIFACT_ROOT }}/${{ matrix.name }}/${{ matrix.application }}/${{ env.BRANCH }}-${{ env.COMMIT_HASH }}"

      - name: Compile Application
        run: |
          set -e

          BRANCH="${{ env.BRANCH }}"
          COMMIT_HASH="${{ env.COMMIT_HASH }}"
          APPLICATION="${{ matrix.application }}"
          OUTDIR="${{ env.ARTIFACT_ROOT }}/${{ matrix.name }}/${APPLICATION}/${BRANCH}-${COMMIT_HASH}"
          mkdir -p "$OUTDIR"

          if [ "$VERSION" = "DEBUG" ]; then
            echo "Building DEBUG firmware ($BRANCH)"
            arduino-cli compile \
              -b esp32:esp32:firefly_controller ./${APPLICATION} \
              --warnings more --clean \
              --build-property "build.extra_flags=-DASYNCWEBSERVER_REGEX -DPRODUCT_HEX=${{ matrix.product_hex }} -DESP32 -DDISABLE_ALL_LIBRARY_WARNINGS -DCORE_DEBUG_LEVEL=4 -I${{ github.workspace }}" \
              --output-dir "$OUTDIR"
          else
            echo "Building RELEASE firmware"
            arduino-cli compile \
              -b esp32:esp32:firefly_controller ./${APPLICATION} \
              --warnings more --clean \
              --build-property "build.extra_flags=-DASYNCWEBSERVER_REGEX -DPRODUCT_HEX=${{ matrix.product_hex }} -DESP32 -DDISABLE_ALL_LIBRARY_WARNINGS -DCORE_DEBUG_LEVEL=0 -DVERSION=\"${VERSION}\" -DCOMMIT_HASH=\"${COMMIT_HASH}\" -I${{ github.workspace }}" \
              --output-dir "$OUTDIR"
          fi

      - name: Create Empty Directory for Use by LittleFS
        run: mkdir -p "${{ env.ARTIFACT_ROOT }}/LittleFS"

      - name: Build LittleFS Images
        run: |
          set -e

          ARDUINO_DIR=$(arduino-cli config dump --format json | jq -r .directories.data)
          OUTDIR="${{ env.ARTIFACT_ROOT }}/${{ matrix.name }}/${{ matrix.application }}/${{ env.BRANCH }}-${{ env.COMMIT_HASH }}"
          mkdir -p "$OUTDIR"

          ${ARDUINO_DIR}/packages/esp32/tools/mklittlefs/**/mklittlefs \
            -s ${{ matrix.partition_size_www }} \
            -c ${{ github.workspace }}/${{ matrix.application }}/www \
            "$OUTDIR/www.bin"

          ${ARDUINO_DIR}/packages/esp32/tools/mklittlefs/**/mklittlefs \
            -s ${{ matrix.partition_size_config }} \
            -c "${{ env.ARTIFACT_ROOT }}/LittleFS" \
            "$OUTDIR/config.bin"

      - name: Generate manifest JSON
        run: |
          ROOT="${{ env.ARTIFACT_ROOT }}"
          NAME="${{ matrix.name }}"
          APPLICATION="${{ matrix.application }}"
          BRANCH="${{ env.BRANCH }}"
          VERSION="${{ env.VERSION }}"
          COMMIT_HASH="${{ env.COMMIT_HASH }}"
          JSON_FILE="${ROOT}/${NAME}/${APPLICATION}/${BRANCH}-${COMMIT_HASH}/manifest.json"

          # Start with an empty JSON array
          FILES_JSON=$(jq -nc '[]')

          # Recursively find all files
          while IFS= read -r f; do
            NAME=$(basename "$f")
            SHA1=$(sha1sum "$f" | awk '{print $1}')

            FILES_JSON=$(echo "$FILES_JSON" \
              | jq -c --arg name "$NAME" --arg sha1 "$SHA1" \
                '. += [{name: $name, sha1: $sha1}]')
          done < <(find "$ROOT" -type f)

          # Build the final JSON object
          jq -nc \
            --arg class "CONTROLLER" \
            --arg product_id "${{ matrix.name }}" \
            --arg application "${{ matrix.application }}" \
            --arg branch "${{ env.BRANCH }}" \
            --arg version "${{ env.VERSION }}" \
            --arg commit "${{ env.COMMIT_HASH }}" \
            --argjson files "$FILES_JSON" \
            '{
              class: $class,
              product_id: $product_id,
              application: $application,
              branch: $branch,
              version: $version,
              commit: $commit,
              files: $files
            }' > "$JSON_FILE"

      - uses: actions/upload-artifact@v4
        name: Upload Artifacts
        with:
          retention-days: 1
          if-no-files-found: error
          name: ${{ matrix.name }}-${{ matrix.application }}-${{ env.BRANCH }}-${{ env.COMMIT_HASH }}
          path: ${{ env.ARTIFACT_ROOT }}/${{ matrix.name }}/${{ matrix.application }}/${{ env.BRANCH }}-${{ env.COMMIT_HASH }}/*

      - name: Upload ZIP to S3
        uses: NotCoffee418/s3-zip-upload@v1.5
        env:
          AWS_SECRET_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
          BUCKET_NAME: ${{ secrets.S3_FIRMWARE_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SOURCE_MODE: ZIP
          SOURCE_PATH: ${{ env.ARTIFACT_ROOT }}/${{ matrix.name }}/${{ matrix.application }}/${{ env.BRANCH }}-${{ env.COMMIT_HASH }}
          DEST_FILE: incoming/${{ matrix.name }}-${{ matrix.application }}-${{ env.BRANCH }}-${{ env.COMMIT_HASH }}.zip