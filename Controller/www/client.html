<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FireFly Controller</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script src="./bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="./common.js"></script>
    <script type="text/javascript" src="./dexie/dexie.min.js"></script>
    <script type="text/javascript" src="./dexie/dexie-export-import.js"></script>
    <script type="text/javascript" src="./database.js"></script>
    <script type="text/javascript" src="./download/download.min.js"></script>
</head>

<body>
    <script>
        loadMenu(null, "menuItemClients");
        initDB();
    </script>

    <div class="container-fluid">
        <div class="row flex-nowrap">
            <div id="menubar" class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 bg-dark d-print-none"></div>
            <div class="col py-3">
                <div><a href="./clients.html">&larr; Back to Clients</a></div>
                <div class="pageTitle" id="pageTitle"></div>
                <div class="pageDescription" id="pageDescription"></div>
                <div>
                    <svg id="clientPreviewImage" viewbox="0 0 400 600">
                        <defs>
                            <radialGradient id="innerGradient">
                                <stop offset="10%" stop-color="#C0C0C0" />
                                <stop offset="95%" stop-color="#a6a6a6" />
                            </radialGradient>
                            <radialGradient id="emptyGradient">
                                <stop offset="10%" stop-color="#595959" />
                                <stop offset="95%" stop-color="#737373" />
                                </radialGradient>
                            <linearGradient id="outerGradient" gradientTransform="rotate(90)">
                                <stop class="stop1" offset="0%" stop-color="#C0C0C0" />
                                <stop class="stop2" offset="50%" stop-color="#C0C0C0" />
                                <stop class="stop3" offset="100%" stop-color="#a6a6a6"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary dropdown-toggle" role="button" id="addNewHID" role="button" data-bs-toggle="dropdown" aria-expanded="false">Add</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" onclick="toggleAddButtonModal();">Button</a></li>
                        <li><a class="dropdown-item" onclick="toggleAddSwitchModal();">Switch</a></li>
                      </ul>
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="button" id="invertButton" onclick="getClient()">Invert</button>
                </div>
                <div class="mt-3">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Color</th>
                                <th scope="col">Switch Type</th>
                                <th scope="col">Actions</th>
                                <th scope="col">Tags</th>
                                <th scope="col">Enabled</th>
                                <th scope="col">Move</th>
                                <th scope="col"></th>
                            </tr>
                          </thead>
                        <tbody id="hidList"></tbody>
                    </table>
                </div>
            </div> 
        </div>
    </div>


    <!-- Add New Button Modal -->
    <div class="modal fade" id="addNewButtonModal" tabindex="-1" aria-labelledby="addNewButtonModalLabel" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form class="needs-validation" novalidate id="addNewButtonForm">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addNewButtonModalLabel">Add New Button</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="input-group-color">Color</span>
                        <div class="input-group-text" id="addNewButtonColorPreview"></div>
                        <select class="form-select" aria-label="Color" id="addNewButtonColor" onchange="setColorPreview();" required>
                            <option value="" selected disabled>Select...</option>
                        </select>
                        <div class="invalid-feedback">
                            Select button color.
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Switch Type</span>
                        <select class="form-select" aria-label="Type" id="addNewButtonSwitchType" required >
                            <option value="NORMALLY_OPEN" selected>Normally Open</option>
                            <option value="NORMALLY_CLOSED">Normally Closed</option>
                        </select>
                        <div class="invalid-feedback">
                            Select button type.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" id="addNewButtonModalAddButton" onclick="addNewButton_click();">Add</button>
                </div>
            </form>
            </div>
        </div>
    </div>


    <!-- Add New Switch Modal -->
    <div class="modal fade" id="addNewSwitchModal" tabindex="-1" aria-labelledby="addNewSwitchModalLabel" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addNewSwitchModalLabel">Add New Switch</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="needs-validation" novalidate id="addNewSwitchForm">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Switch Type</span>
                        <select class="form-select" aria-label="Type" id="addNewSwitchSwitchType" required >
                            <option value="NORMALLY_OPEN" selected>Normally Open</option>
                            <option value="NORMALLY_CLOSED">Normally Closed</option>
                        </select>
                        <div class="invalid-feedback">
                            Select a switch type.
                        </div>
                    </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" id="addNewSwitchModalAddButton" onclick="addNewSwitch_click();">Add</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Add Action Modal-->
    <div class="modal fade" id="addActionModal" tabindex="-1" aria-labelledby="addActionModalLabel" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addActionModalLabel">Add Action</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="needs-validation" novalidate id="addNewActionForm">
                    <input type="hidden" id="addNewActionHID" name="addNewActionHID" value="">
                    <div class="input-group mb-3 has-validation">
                        
                        <span class="input-group-text">When a</span>
                        <select class="form-select" id="addNewActionChangeState" required>
                            <option value="SHORT" selected>Short Change</option>
                            <option value="LONG">Long Change</option>
                        </select>
                        <span class="input-group-text">is observed, make</span>

                        <select class="form-select" id="addNewActionCircuit" required onchange="addActionDrawAvailableActionsForSelectedCircuit();">
                        </select>
                        <div class="invalid-feedback">
                            You must select a circuit.
                        </div>

                        <select class="form-select" id="addNewActionAction" required disabled>
                            <option value="" selected disabled>Select...</option>
                            <option value="INCREASE">Increase</option>
                            <option value="INCREASE_MAXIMUM">Increase Maximum</option>
                            <option value="DECREASE">Decrease</option>
                            <option value="DECREASE_MAXIMUM">Decrease Maximum</option>
                            <option value="TOGGLE">Toggle</option>
                        </select>
                        <div class="invalid-feedback">
                            Select an action to take.
                        </div>
                    
                    </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" id="addNewSwitchModalAddButton" onclick="addActionSave_click();">Add</button>
                </div>
            </div>
        </div>
    </div>
</body>

<script>

    var client={};
    var combinedHIDList=[];
    var colorList=[];
    var circuitList=[];
    var tagList=[];


    var addNewButtonModal = new bootstrap.Modal('#addNewButtonModal');
    var addNewSwitchModal = new bootstrap.Modal('#addNewSwitchModal');
    var addActionModal = new bootstrap.Modal('#addActionModal');


    function toggleAddButtonModal(){
        addNewButtonModal.toggle();
    }


    function toggleAddSwitchModal(){
        addNewSwitchModal.toggle();
    }


    function toggleAddActionModal(element = null){

        if(element != null){
            document.getElementById("addNewActionHID").value = element;
        }
        addActionModal.toggle();
    }


    document.getElementById("addNewButtonModal").addEventListener('show.bs.modal', () => {

        form = document.getElementById("addNewButtonForm");
        form.reset();
        document.getElementById("addNewButtonColor").value = "";
        setColorPreview();
        form.classList.remove('was-validated');
    });


    document.getElementById("addNewSwitchModal").addEventListener('show.bs.modal', () => {

        form = document.getElementById("addNewSwitchForm");
        form.reset();
        form.classList.remove('was-validated');
    });


    document.getElementById("addActionModal").addEventListener('show.bs.modal', () => {

        form = document.getElementById("addNewActionForm");
        form.reset();
        document.getElementById('addNewActionCircuit').value = "";
        document.getElementById('addNewActionAction').disabled = true;
        form.classList.remove('was-validated');
    });

    async function getClient(){

        try{
            client = await db.clients.where('id').equals(parseInt(urlParams.get('id'))).first();
            client.area = await db.areas.where('id').equals(client.area).first();

            if(typeof client == "undefined"){
                throw new Error("Invalid ID.");
            };

            combinedHIDList = [];
            combinedHIDList = combinedHIDList.concat(client.hids.slice());
            combinedHIDList = combinedHIDList.slice(0,maximumHIDsPerInputPort);

            if(typeof client.extends != "undefined"){
                client.extends = await db.clients.where('id').equals(client.extends || {}).first();
                combinedHIDList = combinedHIDList.concat(client.extends.hids.slice());
                combinedHIDList = combinedHIDList.slice(0,maximumHIDsPerClient);
            };

            await Promise.all(combinedHIDList.map(async hid => {
                [hid.color] = await Promise.all([
                    db.colors.where('id').equals(hid.color || []).first()
                ]),
                await Promise.all(hid.actions.map(async action => {
                    [action.circuit] = await Promise.all([
                        db.circuits.where('id').equals(action.circuit).first()
                    ]),
                    [action.circuit.area] = await Promise.all([
                        db.areas.where('id').equals(action.circuit.area).first()
                    ])
                })),
                    hid.actions.sort((a,b) => (a.change_state < b.change_state)? 1 : ((b.change_state < a.change_state) ? -1 : 0));
            }));

            document.getElementById("pageTitle").innerText = client.name;
            document.getElementById("pageDescription").innerHTML = `${client.area.name} ${client.description}`;

            if(combinedHIDList.length == 5){
                document.getElementById("invertButton").hidden = false;
            }else{
                document.getElementById("invertButton").hidden = true;
            }

            await getCircuitList();
            tagList = await db.tags.orderBy('name').toArray()
            await drawHIDPicture();
            await drawHIDList();

        }catch(exception){
            errorHandler(exception);
            window.location.href = "./clients.html";
        }

    }


    function getHIDLocation(total, hid){

        locations = {"1":[[200,300]],"2":[[200,200],[200,400]],"3":[[200,150],[200,300],[200,450]],"4":[[125,200],[275,200],[125,400],[275,400]],"5":[[125,150],[275,150],[125,300],[275,300],[200,450]],"6":[[125,150],[275,150],[125,300],[275,300],[125,450],[275,450]],"51":[[200,150],[125,300],[275,300],[125,450],[275,450]]};

        try{

            if(locations[total] === undefined){
                throw new Error("Missing faceplate definition for size " + total);
            }

            if(locations[total][hid] === undefined){
                throw new Error("Missing HID definition for faceplate " + total + " HID " + (hid + 1));
            }

            return locations[total][hid];

        }catch(exception){
            errorHandler(exception);
        }
    }


    async function getColorList(){

        let colorListSelect = document.getElementById("addNewButtonColor");

        var i, L = colorListSelect.options.length - 1;
        for(i = L; i >= 0; i--) {
            colorListSelect.remove(i);
        }

        colorList = await db.colors.orderBy('name').toArray()
        colorList.forEach((color) =>{
            var opt = document.createElement('option');
            opt.value = color['id'];
            opt.innerHTML = `${color['name']}`;
            colorListSelect.append(opt);
        });

        var opt = document.createElement('option');
        opt.value = "";
        opt.disabled = true;
        opt.selected = true;
        opt.innerHTML = `Select...`;
        colorListSelect.prepend(opt);

    }


    function setColorPreview(){

        let colorListSelect = document.getElementById("addNewButtonColor");
        let colorPreview = document.getElementById("addNewButtonColorPreview");

        if(colorListSelect.value == ""){
            colorPreview.style = getComputedStyle(document.getElementById("input-group-color"));
            return;
        }

        colorList.forEach((color) => {
            if(color.id == colorListSelect.value){
                colorPreview.style.backgroundColor = color.hex;
            }
        })
    }


    async function drawHIDPicture(){

        var svgns = "http://www.w3.org/2000/svg";
        var svg = document.getElementById('clientPreviewImage');
        var addNewHID = document.getElementById('addNewHID');

        try{
           
            for(const element of svg.querySelectorAll("circle")){
                element.remove();
            }

            for(const element of svg.querySelectorAll("rect")){
                element.remove();
            }

            maximumHIDsThisClient = maximumHIDsPerInputPort;

            if(typeof client.extends != "undefined"){
                maximumHIDsThisClient = maximumHIDsPerClient;
            }
            
            if(combinedHIDList.length >= maximumHIDsThisClient){
                addNewHID.disabled = true;
            }else{
                addNewHID.disabled = false;
            }

            for(let i = 0; i < combinedHIDList.length; i++){

                hidLocation = getHIDLocation(combinedHIDList.length, i);

                if(combinedHIDList.length == 5 && document.getElementById("invertButton").classList.contains("active")){
                    hidLocation = getHIDLocation(51, i);
                }

                toolTipText = "";

                combinedHIDList[i].actions.forEach((action) => {

                    var change_state = "";
                    var action_type = "";

                    switch(action.change_state){
                        case "SHORT":
                            change_state = "Short Change";
                            break;
                        case "LONG":
                            change_state = "Long Change";
                            break;
                        default:
                            change_state = "Unknown Change State";
                            break;
                    }

                    switch (action.action){
                        case "INCREASE":
                            action_type = "Increase"; 
                            break;
                        case "INCREASE_MAXIMUM":
                            action_type = "Increase Maximum";
                            break;
                        case "DECREASE":
                            action_type = "Decrease";
                            break;
                        case "DECREASE_MAXIMUM":
                            action_type = "Decrease Maximum";
                            break;
                        case "TOGGLE":
                            action_type = "Toggle";
                            break;
                        default:
                            break;
                    }
                    toolTipText += `<b>${change_state}:</b> ${action_type} ${action.circuit.area.name} ${action.circuit.description} (${action.circuit.name})<hr>`;
                });

                toolTipText = toolTipText.replace(/<hr>$/, '');

                switch(combinedHIDList[i].type){

                    case "BUTTON":
                        var outterButton = document.createElementNS(svgns, "circle");
                        outterButton.setAttributeNS(null, "cx", hidLocation[0]);
                        outterButton.setAttributeNS(null, "cy", hidLocation[1]);
                        outterButton.setAttributeNS(null, "r",  50);
                        outterButton.setAttributeNS(null, "fill", "url('#innerGradient')");
                        outterButton.setAttributeNS(null, "data-bs-toggle", "tooltip");
                        outterButton.setAttributeNS(null, "data-bs-html", "true");
                        outterButton.setAttributeNS(null, "title", `${toolTipText}`);
                        svg.appendChild(outterButton);

                        var innerButton = document.createElementNS(svgns, "circle");
                        innerButton.setAttributeNS(null, "cx", hidLocation[0]);
                        innerButton.setAttributeNS(null, "cy", hidLocation[1]);
                        innerButton.setAttributeNS(null, "r",  33);
                        innerButton.setAttributeNS(null, "stroke", `${combinedHIDList[i]['color']['hex']}`);
                        innerButton.setAttributeNS(null, "stroke-width", "10px");
                        innerButton.setAttributeNS(null, "fill", "url('#innerGradient')");
                        innerButton.setAttributeNS(null, "data-bs-toggle", "tooltip");
                        innerButton.setAttributeNS(null, "data-bs-html", "true");
                        innerButton.setAttributeNS(null, "title", `${toolTipText}`);                     
                        svg.appendChild(innerButton);

                        break;

                    case "SWITCH":
                        var outterSwitch = document.createElementNS(svgns, "rect");
                        outterSwitch.setAttributeNS(null, "x", (hidLocation[0]-50));
                        outterSwitch.setAttributeNS(null, "y", (hidLocation[1]-30));
                        outterSwitch.setAttributeNS(null, "height",  50);
                        outterSwitch.setAttributeNS(null, "width",  100);
                        outterSwitch.setAttributeNS(null, "fill", "#737373");
                        outterSwitch.setAttributeNS(null, "data-bs-toggle", "tooltip");
                        outterSwitch.setAttributeNS(null, "data-bs-html", "true");
                        outterSwitch.setAttributeNS(null, "title", `${toolTipText}`);
                        svg.appendChild(outterSwitch);

                        var innerSwitch = document.createElementNS(svgns, "rect");
                        innerSwitch.setAttributeNS(null, "x", (hidLocation[0]-50));
                        innerSwitch.setAttributeNS(null, "y", (hidLocation[1]-30));
                        innerSwitch.setAttributeNS(null, "height",  50);
                        innerSwitch.setAttributeNS(null, "width",  30);
                        innerSwitch.setAttributeNS(null, "fill", "url('#innerGradient')");
                        innerSwitch.setAttributeNS(null, "data-bs-toggle", "tooltip");
                        innerSwitch.setAttributeNS(null, "data-bs-html", "true");
                        innerSwitch.setAttributeNS(null, "title", `${toolTipText}`);
                        svg.appendChild(innerSwitch);
                        break;

                    default:
                        throw new Error("Unknown HID type " + combinedHIDList[i].type);
                        break;
                }
            }

            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
   
        }catch(exception){
            errorHandler(exception);
        }
    }


    function drawHIDList(){
        var hidList = document.getElementById('hidList');
        hidList.innerHTML = '';

        let i=0;

        combinedHIDList.forEach((hid) =>{

            let hidEntry = `
            <tr>
                <td class="align-middle">${i+1}</td>`

            if(typeof hid.color == "undefined"){
                hidEntry += `<td class="align-middle">None</td>`;
            }else{
                hidEntry += `<td class="align-middle">
                <div class="editableDetails">
                    <span id="ButtonColor_${i}" class="card-title mb-3">${hid.color.name}</span>
                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editButtonColorIcon_${i}" onClick="startEdit(${i}, 'ButtonColor')";">
                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveButtonColorIcon_${i}" onClick="saveEdit(${i}, 'ButtonColor')"; hidden>
                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelButtonColorIcon_${i}" onClick="cancelEdit(${i}, 'ButtonColor')"; hidden>
                </div>
                </td>`;
            }

            hidEntry += `<td class="align-middle">
                <div class="editableDetails">
                    <span id="SwitchType_${i}" class="card-title mb-3">${hid.switch_type.replace("NORMALLY_OPEN", "Normally Open").replace("NORMALLY_CLOSED", "Normally Closed")}</span>
                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editSwitchTypeIcon_${i}" onClick="startEdit(${i}, 'SwitchType')";">
                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveSwitchTypeIcon_${i}" onClick="saveEdit(${i}, 'SwitchType')"; hidden>
                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelSwitchTypeIcon_${i}" onClick="cancelEdit(${i}, 'SwitchType')"; hidden>
                </div>
                </td>
            <td class="align-middle">`;

            j = 0;

            hid.actions.forEach((action)=>{

                var change_state = "";
                var action_type = "";

                switch(action.change_state){
                    case "SHORT":
                        change_state = "Short Change";
                        break;
                    case "LONG":
                        change_state = "Long Change";
                        break;
                    default:
                        change_state = "Unknown Change State";
                        break;
                }

                switch (action.action){
                    case "INCREASE":
                        action_type = "Increase"; 
                        break;
                    case "INCREASE_MAXIMUM":
                        action_type = "Increase Maximum";
                        break;
                    case "DECREASE":
                        action_type = "Decrease";
                        break;
                    case "DECREASE_MAXIMUM":
                        action_type = "Decrease Maximum";
                        break;
                    case "TOGGLE":
                        action_type = "Toggle";
                        break;
                    default:
                        break;
                }

                hidEntry += `<div>${change_state}: ${action_type} ${action.circuit.area.name} ${action.circuit.description} (${action.circuit.name}) <img src="./icons/delete_forever.svg" title="Delete" id="controllerAddButton" class="btn actionDeleteButton" role="button" onclick="deleteAction(${i},${j});"></div>`

                j++;

            })

            hidEntry += `
                <div><button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleAddActionModal(${i});">Add</button></div>
            </td>
            <td class="align-middle">`

                tagList.forEach((tag)=>{
                    if(checkHidHasTag(hid, tag.id)){
                        hidEntry += `<button type="button" class="btn btn-success btn-sm" onclick="deleteTagFromHid(${i},${tag.id});">${tag.name}</button> `
                    }else{
                        hidEntry += `<button type="button" class="btn btn-outline-success btn-sm" onclick="addTagToHid(${i},${tag.id});">${tag.name}</button> `
                    }
                })

            hidEntry += `</td>    

            <td class="align-middle">
                <div class="editableDetails">
                    <span id="Enabled_${i}" class="card-title mb-3";>${hid.enabled.toString().replace("true", "Yes").replace("false", "No")}</span>
                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editEnabledIcon_${i}" onClick="startEdit(${i}, 'Enabled')";">
                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveEnabledIcon_${i}" onClick="saveEdit(${i}, 'Enabled')"; hidden>
                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelEnabledIcon_${i}" onClick="cancelEdit(${i}, 'Enabled')"; hidden>
                </div>
            </td>
            <td class="align-middle">`

            if(i != 0){
                hidEntry += `<button class="btn btn-outline-primary" role="button" onclick="moveHID(${i}, 'up');">&uarr;</button> `
            }

            if(i < combinedHIDList.length-1){
                hidEntry += ` <button class="btn btn-outline-primary" role="button" onclick="moveHID(${i}, 'down');">&darr;</button>`
            }

            hidEntry += `</td>
                <td class="align-middle"><button type="button" class="btn btn-outline-danger" id="deleteHIDButtonChallenge_${i}" onclick="toggleConfirmDeleteHID(${i});">Delete</button>
                    <div class="input-group" id="confirmDeleteHID_${i}" hidden>
                            <input type="text" class="form-control" placeholder="type \'delete\'" id="confirmDeleteText_${i}" oninput="confirmDeleteHIDChallegeOnChange(${i});">
                            <button class="btn btn-secondary" type="button" onclick="toggleConfirmDeleteHID(${i})">Cancel</button>
                            <button class="btn btn-outline-danger" type="button" id="deleteHIDButtonConfirmed_${i}" onclick="deleteHID(${i});" disabled>Delete</button>
                    </div>
                </td>
            </tr>`

            hidList.insertAdjacentHTML('beforeend', hidEntry);
            i++;

        });
    }


    function checkHidHasTag(hid, tagId){

        for(var j=0; j<hid.tags.length; j++){
            if(hid.tags[j] == tagId){return true;}
        }

        return false;
    }


    async function addTagToHid(element, tagId){
        combinedHIDList[element].tags.push(tagId);
        await writeHIDsToDatabase();
        await getClient();
    }

    async function deleteTagFromHid(element, tagId){

        for(var i=0;i<combinedHIDList[element].tags.length; i++){
            if(combinedHIDList[element].tags[i] == tagId){
                combinedHIDList[element].tags.splice(i, 1);
                break;
            }
        }

        await writeHIDsToDatabase();
        await getClient();
    }


    async function deleteAction(hid, element){

        combinedHIDList[hid].actions.splice(element, 1);

        await writeHIDsToDatabase();
        await getClient();
    }


    function toggleConfirmDeleteHID(name){

        if(document.getElementById('deleteHIDButtonChallenge_'+name).hidden == false){
            document.getElementById('deleteHIDButtonChallenge_'+name).hidden = true;
            document.getElementById('confirmDeleteHID_'+name).hidden = false;
        }else{
            document.getElementById('deleteHIDButtonChallenge_'+name).hidden = false;
            document.getElementById('confirmDeleteHID_'+name).hidden = true;
            document.getElementById('confirmDeleteText_'+name).value = "";
        }
    }


    function confirmDeleteHIDChallegeOnChange(name){

        if(document.getElementById('confirmDeleteText_'+name).value == "delete"){
            document.getElementById('deleteHIDButtonConfirmed_'+name).disabled = false;
            document.getElementById('deleteHIDButtonConfirmed_'+name).classList.add('btn-danger');
            document.getElementById('deleteHIDButtonConfirmed_'+name).classList.remove('btn-outline-danger');
        }else{
            document.getElementById('deleteHIDButtonConfirmed_'+name).disabled = true;
            document.getElementById('deleteHIDButtonConfirmed_'+name).classList.add('btn-outline-danger');
            document.getElementById('deleteHIDButtonConfirmed_'+name).classList.remove('btn-danger');
        }
    }


    async function deleteHID(element){

        combinedHIDList.splice(element, 1);

        await writeHIDsToDatabase();
        await getClient();
    }


    async function moveHID(element, direction){

        destination = element;

        if(direction == "down"){
            destination++;
        }else{
            destination--;
        }

        combinedHIDList = move_array(combinedHIDList, element, destination);

        await writeHIDsToDatabase();
        await getClient();
    }


    async function addNewButton_click(){

        let form = document.getElementById("addNewButtonForm");
        form.checkValidity();
        form.classList.add('was-validated');

        if(!form.checkValidity()){
            return;
        }

        await addNewButtonToDatabase();
        await getClient();
        await toggleAddButtonModal();
    }


    async function writeHIDsToDatabase(){

        for(i = 0; i < combinedHIDList.length; i++){

            if(combinedHIDList[i].type == "BUTTON"){
                if(typeof combinedHIDList[i].color.id != "undefined"){
                    combinedHIDList[i].color = combinedHIDList[i].color.id;
                }    
            }

            for(j=0; j < combinedHIDList[i].actions.length; j++){
                if(typeof combinedHIDList[i].actions[j].circuit.id != "undefined"){
                    combinedHIDList[i].actions[j].circuit = combinedHIDList[i].actions[j].circuit.id;
                }
            }

            for(j=0; j < combinedHIDList[i].tags.length; j++){
                if(typeof combinedHIDList[i].tags[j].id != "undefined"){
                    combinedHIDList[i].tags[j] = combinedHIDList[i].tags[j].id;
                }
            }
        }

        await db.clients.where('id').equals(client.id).modify(client =>
            client.hids = combinedHIDList.slice(0,maximumHIDsPerInputPort)
        );

        if(typeof client.extends != "undefined"){
            await db.clients.where('id').equals(client.extends.id).modify(client =>
                client.hids = combinedHIDList.slice(maximumHIDsPerInputPort,maximumHIDsPerClient)
            );
        };
    }


    async function addNewButtonToDatabase(){
        combinedHIDList.push({"color": parseInt(document.getElementById('addNewButtonColor').value), "type":"BUTTON", "switch_type":document.getElementById('addNewButtonSwitchType').value, "enabled": true, "actions":[],"tags":[]});
        await writeHIDsToDatabase();
    }


    async function addNewSwitch_click(){

        let form = document.getElementById("addNewSwitchForm");
        form.checkValidity();
        form.classList.add('was-validated');

        if(!form.checkValidity()){
            return;
        }

        await addNewSwitchToDatabase();
        await getClient();
        await toggleAddSwitchModal();
    }


    async function addNewSwitchToDatabase(){

        combinedHIDList.push({"type":"SWITCH", "switch_type":document.getElementById('addNewSwitchSwitchType').value, "enabled": true, "actions":[],"tags":[]});
        await writeHIDsToDatabase();
    }


    async function addActionSave_click(){

        let form = document.getElementById("addNewActionForm");
        form.checkValidity();
        form.classList.add('was-validated');

        if(!form.checkValidity()){
            return;
        }

        await addNewActionToDatabase();
        await getClient();
        await toggleAddActionModal();
    }


    async function addNewActionToDatabase(){

        combinedHIDList[parseInt(document.getElementById("addNewActionHID").value)].actions.push({
                "change_state": document.getElementById("addNewActionChangeState").value,
                "circuit": parseInt(document.getElementById("addNewActionCircuit").value),
                "action": document.getElementById("addNewActionAction").value
            });

        await writeHIDsToDatabase();
    }


    function addActionDrawAvailableActionsForSelectedCircuit(){

        document.getElementById('addNewActionAction').value = "";

        if(document.getElementById('addNewActionCircuit').value == ""){
            document.getElementById('addNewActionAction').disabled = true;
            
            return;
        }

        document.getElementById('addNewActionAction').disabled = false;

        circuitList.forEach((circuit) =>{

            if(circuit.id == parseInt(document.getElementById('addNewActionCircuit').value)){

                switch(circuit.relay.type){
                    case "BINARY":

                        for(var i = 0; i < document.getElementById('addNewActionAction').options.length; i++){
                            if(document.getElementById('addNewActionAction').options[i].value.includes("INCREASE") || document.getElementById('addNewActionAction').options[i].value.includes("DECREASE")){
                                document.getElementById('addNewActionAction').options[i].hidden = true;
                            }
                        }

                        break;

                    case "VARIABLE":

                        for(var i = 0; i < document.getElementById('addNewActionAction').options.length; i++){
                            if(document.getElementById('addNewActionAction').options[i].value.includes("INCREASE") || document.getElementById('addNewActionAction').options[i].value.includes("DECREASE")){
                                document.getElementById('addNewActionAction').options[i].hidden = false;
                            }
                        }

                        break;

                    default:
                        throw new Error("Unknown relay type " + circuit.relay.type);
                        break;
                }
            }
        });
    }


    async function getCircuitList(){
  
        let circuitSelect = document.getElementById("addNewActionCircuit");

        var i, L = circuitSelect.options.length - 1;
        for(i = L; i >= 0; i--) {
            circuitSelect.remove(i);
        }

        var opt = document.createElement('option');
        opt.value = "";
        opt.disabled = true;
        opt.selected = true;
        opt.innerHTML = `Select...`;
        circuitSelect.prepend(opt);

        circuitList = await db.circuits.orderBy('name').toArray();

        await Promise.all(circuitList.map(async circuit => {
            [circuit.area] = await Promise.all([
                db.areas.where('id').equals(circuit.area).first()
            ]),
            [circuit.relay] = await Promise.all([
                db.relay_models.where('id').equals(circuit.relay_model).first()
            ])
        }));

        circuitList.forEach((circuit) =>{
            var opt = document.createElement('option');
            opt.value = circuit['id'];
            opt.innerHTML = `${circuit['name']}: ${circuit.area.name} ${circuit.description}`;
            circuitSelect.appendChild(opt);
        });  
    }


    function startEdit(id, fieldName){
        switch(fieldName){

            case 'SwitchType':
                if(!document.getElementById("editSwitchTypeSelect_" + id)){
                    element = document.getElementById("SwitchType_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editSwitchTypeSelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }

                editSwitchTypeSelect = document.getElementById("editSwitchTypeSelect_" + id);
                editSwitchTypeSelect.hidden = false;

                var i, L = editSwitchTypeSelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editSwitchTypeSelect.remove(i);
                }

                options = [{"name":"Normally Open", "value":"NORMALLY_OPEN"},{"name":"Normally Closed", "value":"NORMALLY_CLOSED"}]

                options.forEach((option) =>{
                    var opt = document.createElement('option');
                    opt.value = `${option['value']}`;
                    opt.innerHTML = `${option['name']}`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editSwitchTypeSelect.appendChild(opt);
                });
                break;

            case 'ButtonColor':
                if(!document.getElementById("editButtonColorSelect_" + id)){
                    element = document.getElementById("ButtonColor_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editButtonColorSelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }

                editButtonColorSelect = document.getElementById("editButtonColorSelect_" + id);
                editButtonColorSelect.hidden = false;

                var i, L = editButtonColorSelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editButtonColorSelect.remove(i);
                }

                colorList.forEach((color) =>{
                    var opt = document.createElement('option');
                    opt.value = `${color['id']}`;
                    opt.innerHTML = `${color['name']}`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editButtonColorSelect.appendChild(opt);
                });
                break;

            case 'Enabled':

                if(!document.getElementById("editEnabledSelect_" + id)){
                    element = document.getElementById("Enabled_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editEnabledSelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }
            
                editEnabledSelect = document.getElementById("editEnabledSelect_" + id);
                editEnabledSelect.hidden = false;

                var i, L = editEnabledSelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editEnabledSelect.remove(i);
                }

                options = [{"name":"Yes", "value":"true"},{"name":"No", "value":"false"}]

                options.forEach((option) =>{
                    var opt = document.createElement('option');
                    opt.value = `${option['value']}`;
                    opt.innerHTML = `${option['name']}`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editEnabledSelect.appendChild(opt);
                });
                break;

            default:
                errorHandler("Field name " + fieldName + " is not known and cannot be edited");
                break;
        }

        document.getElementById('edit' + fieldName + 'Icon_'+id).hidden = true;
        document.getElementById('save' + fieldName + 'Icon_'+id).hidden = false;
        document.getElementById('cancel' + fieldName + 'Icon_'+id).hidden = false;
    }


    function cancelEdit(id, fieldName){
        element = document.getElementById(fieldName + "_" +id);
        element.contentEditable = "false";
        element.classList.remove("form-control");
        element.innerText = element.getAttribute("previous-value");
        document.getElementById('edit'+ fieldName + 'Icon_'+id).hidden = false;
        document.getElementById('save'+ fieldName + 'Icon_'+id).hidden = true;
        document.getElementById('cancel'+ fieldName + 'Icon_'+id).hidden = true;
    }


    async function saveEdit(id, fieldName){

        switch(fieldName){

            case 'SwitchType':
                combinedHIDList[id].switch_type = document.getElementById("editSwitchTypeSelect_" +id).options[document.getElementById("editSwitchTypeSelect_" +id).selectedIndex].value;
                await writeHIDsToDatabase();
                document.getElementById("SwitchType_" +id).innerText = document.getElementById("editSwitchTypeSelect_" +id).options[document.getElementById("editSwitchTypeSelect_" +id).selectedIndex].text;
                break;

            case 'ButtonColor':
                combinedHIDList[id].color = parseInt(document.getElementById("editButtonColorSelect_" +id).options[document.getElementById("editButtonColorSelect_" +id).selectedIndex].value);
                await writeHIDsToDatabase();
                document.getElementById("ButtonColor_" +id).innerText = document.getElementById("editButtonColorSelect_" +id).options[document.getElementById("editButtonColorSelect_" +id).selectedIndex].text;
                break;

            case 'Enabled':
                combinedHIDList[id].enabled = (String(document.getElementById("editEnabledSelect_" +id).options[document.getElementById("editEnabledSelect_" +id).selectedIndex].value).toLowerCase() === 'true');
                await writeHIDsToDatabase();
                document.getElementById("Enabled_" +id).innerText = document.getElementById("editEnabledSelect_" +id).options[document.getElementById("editEnabledSelect_" +id).selectedIndex].text;
                break;

            default:
                errorHandler("Field name " + fieldName + " is not known and will not be updated");
                break;
        }

        element.contentEditable = "false";
        element.classList.remove("form-control");
        document.getElementById('edit'+ fieldName + 'Icon_'+id).hidden = false;
        document.getElementById('save'+ fieldName + 'Icon_'+id).hidden = true;
        document.getElementById('cancel'+ fieldName + 'Icon_'+id).hidden = true;

        await getClient();
        await drawHIDPicture();
    }


    const urlParams = new URLSearchParams(window.location.search);

    if(isNaN(parseInt(urlParams.get('id')))){
        window.location.href = "./clients.html";
    }

    getClient();
    getColorList();

</script>
</html>