<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FireFly Controller</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script src="./bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="./common.js"></script>
    <script type="text/javascript" src="./dexie/dexie.min.js"></script>
    <script type="text/javascript" src="./dexie/dexie-export-import.js"></script>
    <script type="text/javascript" src="./database.js"></script>
    <script type="text/javascript" src="./download/download.min.js"></script>
</head>

<body>
    <script>
        loadMenu(null, "menuItemCircuits");
        initDB();
    </script>

    <div class="container-fluid">
        <div class="row flex-nowrap">
            <div id="menubar" class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 bg-dark"></div>
            <div class="col py-3">
                <div class="pageTitle">Circuits</div>
                <div class="pageDescription">Circuits define a high-voltage load and are activated when a relay is supplied with a low-voltage output signal.</div>
                
                <div class="sectionHeader mt-5 mb-3">Defined Circuits
                    <img src="./icons/add.svg" title="Add" id="addNewCircuitButton" class="btn" role="button" aria-expanded="false" onclick="toggleAddCircuitModal();">
                </div>
                <div>
                    <div id="circuitListCards" class="row"></div>
                </div>
                <div id="circuitListEmpty" class="container-fluid text-center">Click <img src="./icons/add.svg" title="Add"> add button to start adding circuits.</div>
            </div> 
        </div>
    </div>


    <!-- Add New Circuit Modal -->
    <div class="modal fade" id="addNewCircuitModal" tabindex="-1" aria-labelledby="addNewCircuitModalLabel" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form class="needs-validation" novalidate id="addNewCircuitForm">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addNewCircuitModalLabel">Add New Circuit</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3 has-validation">
                        <span class="input-group-text">Name</span>
                        <input class="form-control" id="addNewCircuitName" placeholder="ex: C23" aria-label="Name" maxlength="8" required>
                        <div class="invalid-feedback">
                            A name is required.
                        </div>
                    </div>
                    <div class="input-group mb-3 has-validation">
                        <span class="input-group-text">Description</span>
                        <input class="form-control" id="addNewCircuitDescription" placeholder="ex: Chandelier" aria-label="Description" maxlength="20" required>
                        <div class="invalid-feedback">
                            A description is required.
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Area</span>
                        <select class="form-select" aria-label="Area" id="addNewCircuitArea" required >
                        </select>
                        <div class="invalid-feedback">
                            Select an area where the load is located.
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Icon</span>
                        <select class="form-select" aria-label="Area" id="addNewCircuitIcon" required >
                        </select>
                        <div class="invalid-feedback">
                            Select an icon for the load.
                        </div>
                    </div>
                    <div class="input-group mb-3 has-validation">
                        <span class="input-group-text">Load Amperage</span>
                        <input class="form-control" id="addNewCircuitAmperage" placeholder="" aria-label="Amperage" type="number" min="0" required>
                        <div class="invalid-feedback">
                            A load amperage is required.
                        </div>
                    </div>
                    <div class="input-group mb-3 no-validation">
                        <span class="input-group-text">Relay Model</span>
                        <select class="form-select" aria-label="Relay Model" id="relayModelSelect" onchange="relayModelDropdownChange();" required></select>
                        <div class="invalid-feedback">
                            Select a relay model option.
                        </div>
                    </div>
                    <div id="customCircuit" class="d-none">
                        <div class="input-group mb-3 has-validation">
                            <span class="input-group-text">Manufacturer</span>
                            <input class="form-control" id="addNewRelayManufacturer" placeholder="" aria-label="Manufacturer" required>
                            <div class="invalid-feedback">
                                A manufacturer is required.
                            </div>
                        </div>
                        <div class="input-group mb-3 has-validation">
                            <span class="input-group-text">Model</span>
                            <input class="form-control" id="addNewRelayModel" placeholder="" aria-label="Model" required>
                            <div class="invalid-feedback">
                                A model is required.
                            </div>
                        </div>
                        <div class="input-group mb-3 has-validation">
                            <span class="input-group-text">Description</span>
                            <input class="form-control" id="addNewRelayDescription" placeholder="" aria-label="Description" required>
                            <div class="invalid-feedback">
                                A description is required.
                            </div>
                        </div>
                        <div class="input-group mb-3 no-validation">
                            <span class="input-group-text">Type</span>
                            <select class="form-select" aria-label="Breaker" id="addNewCircuitType" required>
                                <option value="" selected disabled>Select...</option>
                                <option value="VARIABLE">Variable</option>
                                <option value="BINARY">Binary</option>
                            </select>
                            <div class="invalid-feedback">
                                Select a type option.
                            </div>
                        </div>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Breaker</span>
                        <select class="form-select" aria-label="Breaker" id="addNewCircuitBreaker" required >
                            <option value="" selected disabled>Select...</option>
                        </select>
                        <div class="invalid-feedback">
                            Select a breaker which is powering this circuit.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" id="addNewCircuitButtonAdd" onclick="addNewCircuitButtonAdd_click();">Add</button>
                </div>
            </form>
            </div>
        </div>
    </div>

</body>

<script>

    var addNewCircuitModal = new bootstrap.Modal('#addNewCircuitModal');

    var breakerList = [];
    var relayModelList = [];
    var areaList = [];
    var circuitIconList = [];


    async function addNewCircuitButtonAdd_click(){

        document.getElementById("addNewCircuitName").value = document.getElementById("addNewCircuitName").value.trim();
        document.getElementById("addNewCircuitDescription").value = document.getElementById("addNewCircuitDescription").value.trim();
        document.getElementById("addNewRelayManufacturer").value = document.getElementById("addNewRelayManufacturer").value.trim();
        document.getElementById("addNewRelayModel").value = document.getElementById("addNewRelayModel").value.trim();
        document.getElementById("addNewRelayDescription").value = document.getElementById("addNewRelayDescription").value.trim();

        let form = document.getElementById("addNewCircuitForm");
        form.checkValidity();
        form.classList.add('was-validated');

        if(!form.checkValidity()){
            return;
        }

        await toggleAddCircuitModal();
        await addCircuitToDatabase();
        await drawCircuitList();
    }


    async function addCircuitToDatabase(){
        let relayModelId = parseInt(document.getElementById("relayModelSelect").value)

        if(document.getElementById("relayModelSelect").value == "CUSTOM"){
            relayModelId = await db.relay_models.add({
                manufacturer: document.getElementById("addNewRelayManufacturer").value,
                model: document.getElementById("addNewRelayModel").value,
                description: document.getElementById("addNewRelayDescription").value,
                type: document.getElementById("addNewCircuitType").value,
                is_custom: "true"
            });
        }

        await db.circuits.add({
            name: document.getElementById("addNewCircuitName").value.trim().slice(0,8),
            description: document.getElementById("addNewCircuitDescription").value.trim().slice(0,20),
            area: parseInt(document.getElementById("addNewCircuitArea").value),
            icon: parseInt(document.getElementById("addNewCircuitIcon").value),
            load_amperage: parseInt(document.getElementById("addNewCircuitAmperage").value),
            relay_model: relayModelId,
            breaker: parseInt(document.getElementById("addNewCircuitBreaker").value)
        });
    }


    function toggleAddCircuitModal(){
        addNewCircuitModal.toggle();
    }


    document.getElementById("addNewCircuitModal").addEventListener('show.bs.modal', () => {

        if(areaList.length == 0){
            warningHandler("You must add an area before you can add a circuit.");
            return;
        }

        if(circuitIconList.length == 0){
            warningHandler("You must add an icon before you can add a circuit.");
            return;
        }

        if(breakerList.length == 0){
            warningHandler("You must add a breaker before you can add a circuit.");
            return;
        }

        form = document.getElementById("addNewCircuitForm");
        form.reset();
        document.getElementById("relayModelSelect").value = "";
        document.getElementById("addNewCircuitBreaker").value = "";
        document.getElementById("addNewCircuitType").value = "";
        document.getElementById("customCircuit").classList.add("d-none");
        form.classList.remove('was-validated');
    });


    function relayModelDropdownChange(){

        switch(document.getElementById("relayModelSelect").value){
            case "":
                document.getElementById("customCircuit").classList.add("d-none");
                document.getElementById("addNewRelayManufacturer").value = "";
                document.getElementById("addNewRelayModel").value = "";
                document.getElementById("addNewRelayDescription").value = "";
                document.getElementById("addNewCircuitType").value = "";
                break;

            case "CUSTOM":
                document.getElementById("customCircuit").classList.remove("d-none");
                document.getElementById("addNewRelayManufacturer").value = "";
                document.getElementById("addNewRelayModel").value = "";
                document.getElementById("addNewRelayDescription").value = "";
                document.getElementById("addNewCircuitType").value = "";
                break;

            default:
                document.getElementById("customCircuit").classList.add("d-none");
                relayModelList.forEach((relayModel) => {
                    if(document.getElementById("relayModelSelect").value == relayModel.id){
                        document.getElementById("addNewRelayManufacturer").value = relayModel.manufacturer;
                        document.getElementById("addNewRelayModel").value = relayModel.model;
                        document.getElementById("addNewRelayDescription").value = relayModel.description;
                        document.getElementById("addNewCircuitType").value = relayModel.type;
                    }
                });
                break;
        }
    }


    async function deleteCircuit(id){

        await deleteUnusedCustomRelayModels();

        if(await checkIfInUse_circuit(id) == true){
            warningHandler("Circuit is in use and cannot be deleted.")
            return;
        }

        await db.circuits.delete(id);
        await deleteUnusedCustomRelayModels();
        await drawCircuitList();
    }


    function confirmDeleteCircuitChallegeOnChange(name){

        if(document.getElementById('confirmDeleteText_'+name).value == "delete"){
            document.getElementById('deleteCircuitButtonConfirmed_'+name).disabled = false;
            document.getElementById('deleteCircuitButtonConfirmed_'+name).classList.add('btn-danger');
            document.getElementById('deleteCircuitButtonConfirmed_'+name).classList.remove('btn-outline-danger');
        }else{
            document.getElementById('deleteCircuitButtonConfirmed_'+name).disabled = true;
            document.getElementById('deleteCircuitButtonConfirmed_'+name).classList.add('btn-outline-danger');
            document.getElementById('deleteCircuitButtonConfirmed_'+name).classList.remove('btn-danger');
        }
    }


    function toggleConfirmDeleteCircuit(name){

        if(document.getElementById('deleteCircuitButtonChallenge_'+name).hidden == false){
            document.getElementById('deleteCircuitButtonChallenge_'+name).hidden = true;
            document.getElementById('confirmDeleteCircuit_'+name).hidden = false;
        }else{
            document.getElementById('deleteCircuitButtonChallenge_'+name).hidden = false;
            document.getElementById('confirmDeleteCircuit_'+name).hidden = true;
            document.getElementById('confirmDeleteText_'+name).value = "";
        }
    }


    async function drawCircuitList(){

        try{
            await getBreakerList();
            await getAreaList();
            await getCircuitIconList();
            await getRelayModelList();

            let circuitListCards = document.getElementById("circuitListCards");
            circuitListCards.innerHTML = '';

            const circuits = await db.circuits.orderBy('name').toArray();

            await Promise.all(circuits.map(async circuit => {
                [circuit.breaker] = await Promise.all([
                    db.breakers.where('id').equals(circuit.breaker).first()
                ]),
                [circuit.icon] = await Promise.all([
                    db.circuit_icons.where('id').equals(circuit.icon).first()
                ]),
                [circuit.area] = await Promise.all([
                    db.areas.where('id').equals(circuit.area).first()
                ]),
                [circuit.relay] = await Promise.all([
                    db.relay_models.where('id').equals(circuit.relay_model).first()
                ])
            }));

            if(circuits.length == 0){
                document.getElementById("circuitListEmpty").hidden = false;
                document.getElementById("circuitListCards").hidden = true;
            }else{
                document.getElementById("circuitListEmpty").hidden = true;
                document.getElementById("circuitListCards").hidden = false;
            }

            circuits.forEach((circuit) => {

                let newCircuitCard = `
                <div class="col">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <div class="editableDetails">
                                    <span id="Name_${circuit.id}" class="card-title mb-3 h3" onInput="editFieldRealtimeValidation(${circuit.id}, 'Name')";>${circuit.name}</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editNameIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Name')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveNameIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Name')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelNameIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Name')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Description:</span> <span id="Description_${circuit.id}" onInput="editFieldRealtimeValidation(${circuit.id}, 'Description')";>${circuit.description}</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editDescriptionIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Description')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveDescriptionIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Description')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelDescriptionIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Description')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Area:</span> <span id="Area_${circuit.id}">${circuit.area.name}</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editAreaIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Area')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveAreaIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Area')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelAreaIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Area')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Icon:</span> <span id="Icon_${circuit.id}">${circuit.icon.name}</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editIconIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Icon')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveIconIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Icon')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelIconIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Icon')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Load Amperage:</span> <span id="LoadAmperage_${circuit.id}" onInput="editFieldRealtimeValidation(${circuit.id}, 'LoadAmperage')";>${circuit.load_amperage}</span> Amps
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editLoadAmperageIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'LoadAmperage')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveLoadAmperageIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'LoadAmperage')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelLoadAmperageIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'LoadAmperage')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Relay:</span> <span id="Relay_${circuit.id}">${circuit.relay.manufacturer} ${circuit.relay.model} (${circuit.relay.description})</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editRelayIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Relay')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveRelayIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Relay')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelRelayIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Relay')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Breaker:</span> <span id="Breaker_${circuit.id}">${circuit.breaker.name??"Unknown"} (${circuit.breaker.amperage??"Unknown"} Amps)</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editBreakerIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Breaker')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveBreakerIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Breaker')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelBreakerIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Breaker')"; hidden>
                                </div>
                                <div class="editableDetails">
                                    <span class="col circuitDetailsLabel">Enabled:</span> <span id="Enabled_${circuit.id}">${circuit.enabled.toString().replace("true", "Yes").replace("false", "No")}</span>
                                    <img src="./icons/edit.svg" class="editableContent" title="Edit" id="editEnabledIcon_${circuit.id}" onClick="startEdit(${circuit.id}, 'Enabled')";">
                                    <img src="./icons/check.svg" class="editableContent-save" title="Save" id="saveEnabledIcon_${circuit.id}" onClick="saveEdit(${circuit.id}, 'Enabled')"; hidden>
                                    <img src="./icons/cancel.svg" class="editableContent-cancel" title="Cancel" id="cancelEnabledIcon_${circuit.id}" onClick="cancelEdit(${circuit.id}, 'Enabled')"; hidden>
                                </div>
                                <button type="button" class="btn btn-outline-danger" id="deleteCircuitButtonChallenge_${circuit.id}" onclick="toggleConfirmDeleteCircuit(${circuit.id});">Delete</button>
                                <div class="input-group" id="confirmDeleteCircuit_${circuit.id}" hidden>
                                    <input type="text" class="form-control" placeholder="type \'delete\'" id="confirmDeleteText_${circuit.id}" oninput="confirmDeleteCircuitChallegeOnChange(${circuit.id});">
                                    <button class="btn btn-secondary" type="button" onclick="toggleConfirmDeleteCircuit(${circuit.id})">Cancel</button>
                                    <button class="btn btn-outline-danger" type="button" id="deleteCircuitButtonConfirmed_${circuit.id}" onclick="deleteCircuit(${circuit.id});" disabled>Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`

                circuitListCards.insertAdjacentHTML('beforeend', newCircuitCard);
            });

        }
        catch (exception){
            errorHandler(exception);
        }
    }


    function startEdit(id, fieldName){
        switch(fieldName){

            case 'Name':
            case 'Description':
                element = document.getElementById(fieldName + "_" +id);
                element.setAttribute("previous-value", element.innerText);
                element.contentEditable = "true";
                element.classList.add("form-control");
                editFieldRealtimeValidation(id, fieldName);
                break;

            case 'Area':
                if(!document.getElementById("editAreaSelect_" + id)){
                    element = document.getElementById("Area_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editAreaSelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }

                editAreaSelect = document.getElementById("editAreaSelect_" + id);
                editAreaSelect.hidden = false;

                var i, L = editAreaSelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editAreaSelect.remove(i);
                }

                areaList.forEach((area) =>{
                    var opt = document.createElement('option');
                    opt.value = `${area['id']}`;
                    opt.innerHTML = `${area['name']}`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editAreaSelect.appendChild(opt);
                });
                break;

            case 'Icon':
                if(!document.getElementById("editIconSelect_" + id)){
                    element = document.getElementById("Icon_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editIconSelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }

                editIconSelect = document.getElementById("editIconSelect_" + id);
                editIconSelect.hidden = false;

                var i, L = editIconSelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editIconSelect.remove(i);
                }

                circuitIconList.forEach((icon) =>{
                    var opt = document.createElement('option');
                    opt.value = `${icon['id']}`;
                    opt.innerHTML = `${icon['name']}`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editIconSelect.appendChild(opt);
                });
                break;

            case 'LoadAmperage':
                element = document.getElementById('LoadAmperage_'+id);
                element.setAttribute("previous-value", element.innerText);
                element.contentEditable = "true";
                element.classList.add("form-control");
                element.setAttribute("type", "number");
                element.setAttribute("min", "0");
                element.setAttribute("required", true);
                element.addEventListener("input", (event) => {
                    loadAmperageEditFieldRealtimeValidation(event.target.id);
                })
                break;

            case 'Relay':
                if(!document.getElementById("editRelaySelect_" + id)){
                    element = document.getElementById("Relay_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editRelaySelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }

                editRelaySelect = document.getElementById("editRelaySelect_" + id);
                editRelaySelect.hidden = false;

                var i, L = editRelaySelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editRelaySelect.remove(i);
                }

                relayModelList.forEach((relayModel) =>{
                    var opt = document.createElement('option');
                    opt.value = `${relayModel['id']}`;
                    opt.innerHTML = `${relayModel['manufacturer']} ${relayModel['model']} (${relayModel['description']})`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editRelaySelect.appendChild(opt);
                });
                break;

            case 'Breaker':
                if(!document.getElementById("editBreakerSelect_" + id)){
                    element = document.getElementById("Breaker_" +id);
                    var selectList = document.createElement("select");
                    selectList.id = "editBreakerSelect_" + id;
                    element.setAttribute("previous-value", element.innerText);
                    element.innerText = "";
                    element.appendChild(selectList);
                }

                editBreakerSelect = document.getElementById("editBreakerSelect_" + id);
                editBreakerSelect.hidden = false;

                var i, L = editBreakerSelect.options.length - 1;
                for(i = L; i >= 0; i--) {
                    editBreakerSelect.remove(i);
                }

                breakerList.forEach((breaker) =>{
                    var opt = document.createElement('option');
                    opt.value = `${breaker['id']}`;
                    opt.innerHTML = `${breaker['name']} (${breaker['amperage']} Amps)`;
                    if(opt.innerHTML == element.getAttribute("previous-value")){
                        opt.selected = true;
                    }
                    editBreakerSelect.appendChild(opt);
                });
                break;

            default:
                errorHandler("Field name " + fieldName + " is not known and cannot be edited");
                break;
        }

        document.getElementById('edit' + fieldName + 'Icon_'+id).hidden = true;
        document.getElementById('save' + fieldName + 'Icon_'+id).hidden = false;
        document.getElementById('cancel' + fieldName + 'Icon_'+id).hidden = false;
    }


    function cancelEdit(id, fieldName){
        element = document.getElementById(fieldName + "_" +id);
        element.contentEditable = "false";
        element.classList.remove("form-control");
        element.innerText = element.getAttribute("previous-value");
        document.getElementById('edit'+ fieldName + 'Icon_'+id).hidden = false;
        document.getElementById('save'+ fieldName + 'Icon_'+id).hidden = true;
        document.getElementById('cancel'+ fieldName + 'Icon_'+id).hidden = true;
    }


    async function saveEdit(id, fieldName){
        switch(fieldName){
            case 'Name':
                element = document.getElementById(fieldName + "_" +id);
                await db.circuits.update(id, {name: element.innerText.trim()});
                break;
            case 'Description':
                element = document.getElementById(fieldName + "_" +id);
                await db.circuits.update(id, {description: element.innerText.trim()});
                break;
            case 'Area':
                element = document.getElementById("editAreaSelect_" +id);
                await db.circuits.update(id, {area: parseInt(element.value)});
                document.getElementById("editAreaSelect_" +id).hidden = true;
                document.getElementById("Area_" +id).innerText = document.getElementById("editAreaSelect_" +id).options[document.getElementById("editAreaSelect_" +id).selectedIndex].text;
                break;
            case 'Icon':
                element = document.getElementById("editIconSelect_" +id);
                await db.circuits.update(id, {icon: parseInt(element.value)});
                document.getElementById("editIconSelect_" +id).hidden = true;
                document.getElementById("Icon_" +id).innerText = document.getElementById("editIconSelect_" +id).options[document.getElementById("editIconSelect_" +id).selectedIndex].text;
                break;
            case 'LoadAmperage':
                element = document.getElementById(fieldName + "_" +id);
                await db.circuits.update(id, {load_amperage: parseInt(element.innerText.trim())});
                break;
            case 'Relay':
                element = document.getElementById("editRelaySelect_" +id);
                await db.circuits.update(id, {relay_model: parseInt(element.value)});
                document.getElementById("editRelaySelect_" +id).hidden = true;
                document.getElementById("Relay_" +id).innerText = document.getElementById("editRelaySelect_" +id).options[document.getElementById("editRelaySelect_" +id).selectedIndex].text;
                break;
            case 'Breaker':
                element = document.getElementById("editBreakerSelect_" +id);
                await db.circuits.update(id, {breaker: parseInt(element.value)});
                document.getElementById("editBreakerSelect_" +id).hidden = true;
                document.getElementById("Breaker_" +id).innerText = document.getElementById("editBreakerSelect_" +id).options[document.getElementById("editBreakerSelect_" +id).selectedIndex].text;
                break;
            default:
                errorHandler("Field name " + fieldName + " is not known and will not be updated");
                break;
        }

        element.contentEditable = "false";
        element.classList.remove("form-control");
        document.getElementById('edit'+ fieldName + 'Icon_'+id).hidden = false;
        document.getElementById('save'+ fieldName + 'Icon_'+id).hidden = true;
        document.getElementById('cancel'+ fieldName + 'Icon_'+id).hidden = true;
    }


    function editFieldRealtimeValidation(id, fieldName){
        element = document.getElementById(fieldName + "_" +id);

        if(element.innerText.trim().length > 0){
            element.classList.remove("is-invalid");
            element.classList.add("is-valid");
            document.getElementById('save'+ fieldName + 'Icon_'+id).hidden = false;
        }else{
            element.classList.add("is-invalid");
            element.classList.remove("is-valid");
            document.getElementById('save'+ fieldName + 'Icon_'+id).hidden = true;
        }
    }


    async function getBreakerList(){

        let breakerSelect = document.getElementById("addNewCircuitBreaker");

        var i, L = breakerSelect.options.length - 1;
        for(i = L; i >= 0; i--) {
            breakerSelect.remove(i);
        }

        breakerList = await db.breakers.orderBy('name').toArray()

        breakerList.forEach((breaker) =>{
            var opt = document.createElement('option');
            opt.value = breaker['id'];
            opt.innerHTML = `${breaker['name']} (${breaker['amperage']} Amps)`;
            breakerSelect.appendChild(opt);
        });

        var opt = document.createElement('option');
        opt.value = "";
        opt.selected = true;
        opt.disabled = true;
        opt.innerHTML = `Select...`;
        breakerSelect.prepend(opt);
    }


    async function getAreaList(){

        let areaSelect = document.getElementById("addNewCircuitArea");

        var i, L = areaSelect.options.length - 1;
        for(i = L; i >= 0; i--) {
            areaSelect.remove(i);
        }

        areaList = await db.areas.orderBy('name').toArray()

        areaList.forEach((area) =>{
            var opt = document.createElement('option');
            opt.value = `${area['id']}`;
            opt.innerHTML = `${area['name']}`;
            areaSelect.appendChild(opt);
        });

        var opt = document.createElement('option');
        opt.value = "";
        opt.selected = true;
        opt.innerHTML = `Select...`;
        areaSelect.prepend(opt);
    }


    async function getCircuitIconList(){

        let iconSelect = document.getElementById("addNewCircuitIcon");

        var i, L = iconSelect.options.length - 1;
        for(i = L; i >= 0; i--) {
            iconSelect.remove(i);
        }

        circuitIconList = await db.circuit_icons.orderBy('name').toArray()

        circuitIconList.forEach((icon) =>{
            var opt = document.createElement('option');
            opt.value = icon['id'];
            opt.innerHTML = `${icon['name']}`;
            iconSelect.appendChild(opt);
        });

        var opt = document.createElement('option');
        opt.value = "";
        opt.selected = true;
        opt.innerHTML = `Select...`;
        iconSelect.prepend(opt);
    }


    async function getRelayModelList(){

        let relayModelSelect = document.getElementById("relayModelSelect");

        var i, L = relayModelSelect.options.length - 1;
        for(i = L; i >= 0; i--) {
            relayModelSelect.remove(i);
        }

        relayModelList = await db.relay_models.orderBy('[manufacturer+model]').toArray()
        relayModelList.forEach((relayModel) =>{
            var opt = document.createElement('option');
            opt.value = relayModel['id'];
            opt.innerHTML = `${relayModel['manufacturer']} ${relayModel['model']} (${relayModel['description']})`;
            relayModelSelect.append(opt);
        });

        var opt = document.createElement('option');
        opt.value = "";
        opt.disabled = true;
        opt.innerHTML = `Select...`;
        relayModelSelect.prepend(opt);

        var opt = document.createElement('option');
        opt.value = "CUSTOM";
        opt.innerHTML = `Custom`;
        relayModelSelect.append(opt);
    }



    function loadAmperageEditFieldRealtimeValidation(element){

        let id = element.replace("LoadAmperage_", "");
        loadAmperageElement = document.getElementById(element);

        var regex = /^[0-9]+$/;

        if(regex.test(loadAmperageElement.innerText)){
            loadAmperageElement.classList.remove("is-invalid");
            loadAmperageElement.classList.add("is-valid");
            document.getElementById('saveLoadAmperageIcon_'+id).hidden = false;
        }else{
            loadAmperageElement.classList.add("is-invalid");
            loadAmperageElement.classList.remove("is-valid");
            document.getElementById('saveLoadAmperageIcon_'+id).hidden = true;
        }
    }

    drawCircuitList();

</script>
</html>