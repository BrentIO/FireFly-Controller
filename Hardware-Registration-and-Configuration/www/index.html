<!doctype html>
<html lang="en">
    <head>
        <title>Hardware Configuration</title>
        <link href="./bootstrap.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="./bootstrap.min.js"></script>
        <script>

            let api_root = "./api";
            let ui_root = "./ui"
            let mcu = {};
            let network = [];
            let identification = null;
            let auxillary_data = null;
            let partitions = [];
            let peripherals = [];
            let eventLog = [];
            let errorLog = [];
            let application_version = null;
            let ui_version = null;
            let certificates = [];
            let visual_token = "";
            let otaConfig = {};

            const api_timeout = 5000;


            window.onload = function(){

                document.getElementById("eventLog-tab").addEventListener('shown.bs.tab', function (event) {
                    getEventLog();
                });

                document.getElementById("errorLog-tab").addEventListener('shown.bs.tab', function (event) {
                    getErrorLog();
                });

                loadData();
            }

            async function loadData(){
                setCopyright();
                getMCU();
                getIdentification();
                getNetwork();
                getPartitions();
                getPeripherals();
                getEventLog();
                getErrorLog();
                getUIVersion();
                await getCertificates();
                getOtaUpdate();
            }


            async function authenticate(){

                if(visual_token){
                    return true;
                }

                try{
                    let visualTokenPrompt = prompt("Enter the visual token");

                    if(visualTokenPrompt == null){
                        throw new Error("Authentication cancelled");
                    }

                    let response = await fetch("/auth", {
                        signal: AbortSignal.timeout(api_timeout), 
                        method: 'POST',
                        headers: {
                            "x-visual-token":visualTokenPrompt
                        }
                    });

                    switch(response.status){
                        case 204:
                            visual_token = visualTokenPrompt;
                            return true;
                            break;

                        case 401:
                            createErrorToast("Authentication failed", "Verify the visual token");
                            visual_token = "";
                            break;

                        default:
                            visual_token = "";
                            throw new Error("Unable to authenticate " + response.url + " (" + response.status + ")");
                    }

                    return false;
                }
                catch(err){                  
                    if (err.name === "AbortError") {
                        createErrorToast("Unable to authenticate", "Timeout");
                    } else {
                        createErrorToast("Unable to authenticate", err);
                    }

                    return false;
                }
            }


            function setCopyright(){
                const d = new Date();
                document.getElementById("copyright").innerText = "2019-" + d.getFullYear();
            }


            function key_password_toggle() {
                var x = document.getElementById("key");
                var show_eye = document.getElementById("identification-key-show_eye");
                var hide_eye = document.getElementById("identification-key-hide_eye");
                hide_eye.classList.remove("d-none");
                if (x.type === "password") {
                    x.type = "text";
                    show_eye.style.display = "none";
                    hide_eye.style.display = "block";
                } else {
                    x.type = "password";
                    show_eye.style.display = "block";
                    hide_eye.style.display = "none";
                }
            }


            function product_id_toggle(){
                var x = document.getElementById("product_id");

                if (x.disabled == true) {
                    x.disabled = false;
                    product_id_icon("lock");
                } else {
                    x.disabled = true;
                    product_id_icon("unlocked");
                }

            }


            function product_id_icon(value){

                var unlock = document.getElementById("identification-product_id-unlock");
                var lock = document.getElementById("identification-product_id-lock");
                lock.classList.remove("d-none");

                if(value == "lock"){
                    unlock.style.display = "none";
                    lock.style.display = "block";
                }else{
                    unlock.style.display = "block";
                    lock.style.display = "none";
                }

            }


            function bytesToSize(bytes) {
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']
                if (bytes === 0) return 'n/a'
                const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)), 10)
                if (i === 0) return `${bytes} ${sizes[i]})`
                return `${(bytes / (1024 ** i)).toFixed(1)} ${sizes[i]}`
            }


            function interfaceNameFormat(value){

                switch(value.toLowerCase()){

                    case "bluetooth":
                        return "Bluetooth";
                        break;

                    case "ethernet":
                        return "Ethernet";
                        break;

                    case "wifi":
                        return "WiFi";
                        break;

                    case "wifi_ap":
                        return "WiFi AP";
                        break;

                    default:
                        return value;
                        break;
                }
            }


            function peripheralTypeNameFormat(value){
                switch(value.toLowerCase()){

                    case "input":
                        return "Input";
                        break;

                    case "output":
                        return "Output";
                        break;
                    
                    case "temperature":
                        return "Temperature";
                        break;

                    case "oled":
                        return "OLED";
                        break;

                    case "eeprom":
                        return "EEPROM";
                        break;

                    default:
                        return value;
                        break;
                }
            }


            function computePartitionScheme(data){

                data = data.sort((a, b) => {
                    if (a.address < b.address) {
                        return -1;
                    }
                });

                return data;

            }


            function errorHandler_get_div(element){
                document.getElementById(element).innerHTML = `<div class="d-flex justify-content-center align-items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-exclamation-triangle-fill text-danger" width="10%" height="10%" viewBox="0 0 16 16">
                                                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                                                </svg></div>`;

            }


            function errorHandler_get_inline(element){
                document.getElementById(element).innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-exclamation-triangle-fill text-danger" width="20" height="20" viewBox="0 0 16 16">
                                                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                                                </svg>`;
            }


            function prependWarningLabel(element){
                document.getElementById(element).innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-exclamation-triangle-fill text-danger" width="20" height="20" viewBox="0 0 16 16">
                                                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                                                </svg> ` + document.getElementById(element).innerHTML;

            }


            async function getMCU(){

                try{
                    let response = await fetch(api_root + "/mcu", { signal: AbortSignal.timeout(api_timeout) });

                    if (response.ok) {
                        mcu = await response.json();
                        drawMCU();
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("mcu-tab");
                        createErrorToast("Unable to get MCU", "Timeout");
                        errorHandler_get_inline("chip_model");
                        errorHandler_get_inline("chip_revision");
                        errorHandler_get_inline("flash_chip_size");
                        errorHandler_get_inline("boot_time");

                    } else {
                        prependWarningLabel("mcu-tab");
                        createErrorToast("Unable to get MCU", err);
                        errorHandler_get_inline("chip_model", );
                        errorHandler_get_inline("chip_model");
                        errorHandler_get_inline("chip_revision");
                        errorHandler_get_inline("flash_chip_size");
                        errorHandler_get_inline("boot_time");
                    }
                }                
            }


            function drawMCU(){

                if(mcu == {}){
                    return;
                }

                document.getElementById("chip_model").innerText = mcu['chip_model'];
                document.getElementById("chip_revision").innerText = mcu['revision'];
                document.getElementById("flash_chip_size").innerText = bytesToSize(mcu['flash_chip_size']);
                document.getElementById("boot_time").innerText = new Date(mcu['boot_time']*1000).toLocaleString();
            }


            async function getNetwork(){

                try{
                    let response = await fetch(api_root + "/network", { signal: AbortSignal.timeout(api_timeout) })

                    if (response.ok) {
                        network = await response.json();
                        drawNetwork();
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("network-tab");
                        errorHandler_get_div("network-tab-pane");
                        createErrorToast("Unable to get Network", "Timeout");
                    } else {
                        prependWarningLabel("network-tab");
                        errorHandler_get_div("network-tab-pane");
                        createErrorToast("Unable to get Network", err);
                    }
                }
            }


            function drawNetwork(){

                if(network == []){
                    return;
                }

                var table = document.getElementById('network-tab-table-data');

                network = network.sort((a, b) => {
                    if (a.interface < b.interface) {
                        return -1;
                    }
                });

                network.forEach(function(element){

                    var row = table.insertRow();

                    var colInterface = row.insertCell();
                    var colMacAddress = row.insertCell();

                    colInterface.innerText = interfaceNameFormat(element.interface);
                    colMacAddress.innerText = element.mac_address;
                });

                document.getElementById('network-tab-table').classList.remove("d-none");
                document.getElementById('network-tab-wait-spinner').classList.add("d-none");
                
            }


            async function getIdentification(){

                try{
                    let response = await fetch(api_root + "/eeprom", { signal: AbortSignal.timeout(api_timeout) });
                    
                    switch(response.status){
                        case 200:
                            identification = await response.json();
                            drawIdentification();
                            break;

                        case 404:
                            identification = null
                            drawIdentification();
                            break;

                        default:
                            throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    if (err.name === "AbortError") {
                        errorHandler_get_div("identification-tab-pane");
                        prependWarningLabel("identification-tab");
                        createErrorToast("Unable to get Identification", "Timeout");
                    } else {
                        errorHandler_get_div("identification-tab-pane");
                        prependWarningLabel("identification-tab");
                        createErrorToast("Unable to get Identification", err);
                    }
                }

                document.getElementById('identification-tab-content').classList.remove("d-none");
                document.getElementById('identification-tab-wait-spinner').classList.add("d-none");

            }


            function uuidv4() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
                .replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0, 
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }


            function drawIdentification(){

                if(identification === null){
                    document.getElementById("identification-alert").classList.add("d-none");
                    document.getElementById("uuid").value = uuidv4();
                    document.getElementById("key").value = generateRandomString(64);
                    disable_identification_save_button(false);
                    disable_identification_delete_button(true);
                    document.getElementById("identification-save-button").disabled = false;
                    return;
                }

                document.getElementById("identification-alert").classList.remove("d-none");
                disable_identification_save_button(true);
                disable_identification_delete_button(false);
                document.getElementById("uuid").value = identification['uuid'];
                document.querySelector("#product_id").value = identification['product_id'];
                document.getElementById("key").value = identification['key'];
            }


            async function deleteIdentification(){

                try{

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    var spinner = document.getElementById("identification-delete-button-spinner");
                    var icon = document.getElementById("identification-delete-button-icon");
                    spinner.classList.remove("d-none");
                    icon.classList.add("d-none");

                    disable_identification_save_button(true);
                    disable_identification_delete_button(true);

                    let response = await fetch(api_root + "/eeprom", {
                        signal: AbortSignal.timeout(api_timeout), 
                        method: 'DELETE',
                        headers: {
                            "x-visual-token":visual_token
                        }
                    });
                    
                    switch(response.status){
                        case 204:
                            createSuccessToast("Success", "Identification has been deleted");
                            getIdentification();
                            break;

                        case 401:
                            createErrorToast("Unable to delete identification", "Authentication failed");
                            disable_identification_delete_button(false);
                            break;

                        default:
                            disable_identification_delete_button(false);
                            throw new Error("Unable to delete identification " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    if (err.name === "AbortError") {
                        disable_identification_delete_button(false);
                        createErrorToast("Unable to delete identification", "Timeout");
                    } else {
                        disable_identification_delete_button(false);
                        createErrorToast("Unable to delete identification", err);
                    }
                }

                spinner.classList.add("d-none");
                icon.classList.remove("d-none");
            }


            async function postIdentification(){

                try{

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    var spinner = document.getElementById("identification-save-button-spinner");
                    var icon = document.getElementById("identification-save-button-icon");
                    spinner.classList.remove("d-none");
                    icon.classList.add("d-none");

                    disable_identification_save_button(true);
                    disable_identification_delete_button(true);

                    document.getElementById("uuid").value = document.getElementById("uuid").value.trim();
                    document.getElementById("key").value = document.getElementById("key").value.trim();


                    if(document.getElementById("uuid").value.length != 36){
                        disable_identification_save_button(false);
                        throw new Error("Device UUID must be exactly 36 characters");
                    }

                    if(document.getElementById("product_id").value == ""){
                        disable_identification_save_button(false);
                        throw new Error("No Product ID was selected");
                    }

                    if(document.getElementById("key").value.length != 64){
                        disable_identification_save_button(false);
                        throw new Error("Key must be exactly 64 characters");
                    }

                    payload = {}

                    payload['uuid'] = document.getElementById("uuid").value;
                    payload['product_id'] = document.getElementById("product_id").value;
                    payload['key'] = document.getElementById("key").value;
                 
                    let response = await fetch(
                        api_root + "/eeprom", 
                        { signal: AbortSignal.timeout(api_timeout), 
                          method: 'POST',
                          headers: {
                            "content-type":"application/json",
                            "x-visual-token":visual_token
                          },
                          body:JSON.stringify(payload)
                        });
                    
                    switch(response.status){
                        case 201:
                            createSuccessToast("Success", "Identification has been created");
                            getIdentification();
                            break;

                        case 401:
                            createErrorToast("Unable to save identification", "Authentication failed");
                            disable_identification_save_button(false);
                            break;

                        default:
                            disable_identification_save_button(false);
                            throw new Error("Unable to save " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    if (err.name === "AbortError") {
                        disable_identification_save_button(false);
                        createErrorToast("Unable to save identification", "Timeout");
                    } else {
                        disable_identification_save_button(false);
                        createErrorToast("Unable to save identification", err);
                    }
                }

                spinner.classList.add("d-none");
                icon.classList.remove("d-none");

            }


            function disable_identification_save_button(value){

                var button = document.getElementById("identification-save-button");

                if(identification != null){
                    button.disabled = true;
                    return;
                }

                button.disabled = value;

            }


            function disable_identification_delete_button(value){

                var button = document.getElementById("identification-delete-button");

                if(identification == null){
                    button.disabled = true;
                    return;
                }

                button.disabled = value;

            }


            function toggle_identification_save_delete(){

                var save_button = document.getElementById("identification-save-button");
                var delete_button = document.getElementById("identification-delete-button");

                if (save_button.disabled == true) {
                    save_button.disabled = false;

                    if(identification != null){
                        delete_button.disabled = false;
                    }
                    
                } else {
                    save_button.disabled = true;
                    delete_button.disabled = true;
                }

            }


            function drawProduct_Ids(){

                if(auxillary_data === null){
                    throw new Error("No auxillary data found");
                    return;
                }

                product_ids = auxillary_data.sort((a, b) => {
                    if (a.product_id < b.product_id) {
                        return -1;
                    }
                });

                var dropdown = document.getElementById("product_id");

                if(dropdown === null){
                    return; //The form was destroyed
                }

                var optionSelectAProductId = document.createElement("option");
                    optionSelectAProductId.value = "";
                    optionSelectAProductId.text = "-- Select a Product ID -- ";
                    optionSelectAProductId.selected = true;
                    dropdown.add(optionSelectAProductId);
                    product_id_icon("lock");

                product_ids.forEach(function(element){

                    var option = document.createElement("option");
                    option.value = element.product_id;
                    option.text = element.product_id;
                    option.setAttribute("product_hex", element.product_hex);
                    dropdown.add(option);
                });


                for(let i=0; i < document.getElementById("product_id").options.length; i++){
                    if(document.getElementById("product_id").options[i].getAttribute("product_hex") == application_version['product_hex']){
                        document.getElementById("product_id").options[i].selected = true;
                        product_id_toggle();
                        product_id_icon("unlocked");
                    }
                }
            }


            async function getPartitions(){

                try{
                    let application_version_response = await fetch(api_root + "/version", { signal: AbortSignal.timeout(api_timeout) });

                    if (application_version_response.ok) {
                        application_version = await application_version_response.json();
                        drawApplicationVersion()
                    } else {
                        throw new Error("Unable to get " + application_version_response.url + " (" + application_version_response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("about-tab");
                        errorHandler_get_inline("about-hardware-product-hex");
                        errorHandler_get_inline("about-application-version");
                        createErrorToast("Unable to get application version", "Timeout");
                    } else {
                        prependWarningLabel("about-tab");
                        errorHandler_get_inline("about-hardware-product-hex");
                        errorHandler_get_inline("about-application-version");
                        createErrorToast("Unable to get application version", err);
                    }
                }

                try{

                    let aux_data_response = await fetch("./auxillary_data.json", { signal: AbortSignal.timeout(api_timeout) });

                    if (aux_data_response.ok) {
                        auxillary_data = await aux_data_response.json();
                        drawProduct_Ids();
                    } else {
                        throw new Error("Unable to get " + aux_data_response.url + " (" + aux_data_response.status + ")");
                    }
                    }
                    catch(err){
                    if (err.name === "AbortError") {
                        createErrorToast("Unable to get Auxillary Data", "Timeout");
                    } else {
                        createErrorToast("Unable to get Auxillary Data", err);
                    }
                }

                try{

                    let partitions_response = await fetch(api_root + "/partitions", { signal: AbortSignal.timeout(api_timeout) });

                    if (partitions_response.ok) {
                        partitions = await partitions_response.json();

                        try{
                            partitions = computePartitionScheme(partitions);
                            checkPartitionScheme();
                            drawPartitions();
                        }
                        catch(err){
                            prependWarningLabel("partition-table-tab");
                            errorHandler_get_div("partition-table-tab-pane");
                            createErrorToast("Error Checking Partition Table", err.message);
                        }

                    } else {
                        throw new Error("Unable to get " + partitions_response.url + " (" + partitions_response.status + ")");
                    }
                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("partition-table-tab");
                        errorHandler_get_div("partition-table-tab-pane");
                        createErrorToast("Unable to get Partition Table", "Timeout");
                        return;
                    } else {
                        prependWarningLabel("partition-table-tab");
                        errorHandler_get_div("partition-table-tab-pane");
                        createErrorToast("Unable to get Partition Table", err);
                        return;
                    }
                }
               
            }


            function drawPartitions(){

                var countOfIssues = 0;

                if(partitions == []){
                    errorHandler_get_div("No partitions found");
                    return;
                }

                var table = document.getElementById('partition-tab-table-data');

                partitions.forEach(function (element){

                    var row = table.insertRow();

                    var colType = row.insertCell();
                    var colSubType = row.insertCell();
                    var colAddress = row.insertCell();
                    var colSize = row.insertCell();
                    var colLabel = row.insertCell();
                    var colStatus = row.insertCell();

                    colType.innerText = "0x" + element.type.toString(16).padStart(2, '0');
                    colSubType.innerText = "0x" + element.subtype.toString(16).padStart(2, '0');
                    colAddress.innerText = "0x" + element.address.toString(16).padStart(6, '0').toUpperCase();
                    colSize.innerText = bytesToSize(element.size) + " (" + "0x" + element.size.toString(16).padStart(6, '0') + ")";
                    colLabel.innerText = element.label;

                    if(!element.hasOwnProperty('status')){
                        element.status = [];
                        element.status.push("Error Comparing Partition Table Data");

                    }

                    if(element.status.length == 0){
                        colStatus.innerHTML = `<span class="badge bg-success">OK</span>`
                    }else{

                        element.status.forEach(function(status){

                            countOfIssues++;
                            colStatus.innerHTML = colStatus.innerHTML + `<span class="badge bg-danger">${status}</span>`

                        });
                    }
                });

                if(countOfIssues > 0){
                    prependWarningLabel("partition-table-tab");
                    createErrorToast("Partition Table", "One or more partitions have errors");
                }

                document.getElementById('partition-tab-table').classList.remove("d-none");
                document.getElementById('partition-tab-wait-spinner').classList.add("d-none");
            }


            function checkPartitionScheme(){

                if(partitions.length == 0){
                    throw new Error("No partitions returned by API");
                    return;
                }

                if(auxillary_data.length == 0){
                    throw new Error("No partition schemes found in auxillary data");
                    return;
                }

                if(application_version === null){
                    throw new Error("Application version information is missing");
                    return;
                }

                partition_scheme = [];

                partition_scheme = auxillary_data.filter(function(element){

                    if(element.product_hex == application_version['product_hex']){
                        return element;
                    }

                });

                if(partition_scheme.length == 0 ){
                    throw new Error("No match between product hex and auxillary data.  Either the product hex is wrong, or the auxillary data needs to be updated for the hardware type");
                    return;
                }


                if(partition_scheme.length != 1 ){
                    throw new Error("Partition scheme length of " + partition_scheme.length + ", expected exactly 1");
                    return;
                }

                partition_scheme = computePartitionScheme(partition_scheme[0].partition_scheme);


                if(partition_scheme.length != partitions.length){
                    throw new Error("The number of partitions in auxillary data for this product hex and the actual number of partitions reported by the hardware do not match");
                    return;
                }


                for(var i=0; i < partition_scheme.length; i++){

                    partitions[i]['status'] = [];

                    if(partition_scheme[i].type != partitions[i].type){
                        partitions[i]['status'].push("Unexpected Type");
                    }

                    if(partition_scheme[i].subtype != partitions[i].subtype){
                        partitions[i]['status'].push("Unexpected Subtype");
                    }

                    if(partition_scheme[i].address != partitions[i].address){
                        partitions[i]['status'].push("Unexpected Address");
                    }

                    if(partition_scheme[i].size != partitions[i].size){
                        partitions[i]['status'].push("Unexpected Size");
                    }

                    if(partition_scheme[i].label != partitions[i].label){
                        partitions[i]['status'].push("Unexpected Label");
                    }
                }

            }


            async function getPeripherals(){

                try{
                    let response = await fetch(api_root + "/peripherals", { signal: AbortSignal.timeout(api_timeout) });

                    if (response.ok) {
                        peripherals = await response.json();
                        drawPeripherals()
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("peripherals-tab");
                        errorHandler_get_div("peripherals-tab-pane");
                        createErrorToast("Unable to get Peripherals", "Timeout");
                    } else {
                        prependWarningLabel("peripherals-tab");
                        errorHandler_get_div("peripherals-tab-pane");
                        createErrorToast("Unable to get Peripherals", err);
                    }
                }
            }


            function drawPeripherals(){

                if(peripherals == []){
                    return;
                }

                var table = document.getElementById('peripheral-tab-table-data');

                var countOffline = 0;

                peripherals.forEach(function (element){
                    var row = table.insertRow();

                    var colAddress = row.insertCell();
                    var colType = row.insertCell();
                    var colOnline = row.insertCell();

                    colAddress.innerHTML = element.address;
                    colType.innerHTML = peripheralTypeNameFormat(element.type);

                    if(element.online == true){
                        colOnline.innerHTML = `<span class="badge bg-success">Online</span>`;
                    }else{
                        colOnline.innerHTML = `<span class="badge bg-danger">Offline</span>`;
                        countOffline++;
                    }
                });


                if(countOffline > 0){
                    prependWarningLabel("peripherals-tab");
                    createErrorToast("Peripherals Offline", "One or more peripherals are offline");
                }

                document.getElementById('peripheral-tab-table').classList.remove("d-none");
                document.getElementById('peripheral-tab-wait-spinner').classList.add("d-none");

            }


            async function getEventLog(){

                eventLog = [];

                document.getElementById('eventLog-tab-table').classList.add("d-none");
                document.getElementById('eventLog-tab-wait-spinner').classList.remove("d-none");

                try{
                    let response = await fetch(api_root + "/events", { signal: AbortSignal.timeout(api_timeout) });

                    if (response.ok) {
                        eventLog = await response.json();
                        drawEventLog()
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("eventLog-tab");
                        errorHandler_get_div("eventLog-tab-pane");
                        createErrorToast("Unable to get Event Log", "Timeout");
                    } else {
                        prependWarningLabel("eventLog-tab");
                        errorHandler_get_div("eventLog-tab-pane");
                        createErrorToast("Unable to get Event Log", err);
                    }
                }
            }


            function drawEventLog(){

                var table = document.getElementById('eventLog-tab-table-data');

                table.innerHTML = "";

                if(eventLog.length == 0){
                    document.getElementById('eventLog-count').classList.add("d-none");
                    document.getElementById('eventLog-tab-table').classList.add("d-none");
                    document.getElementById('eventLog-tab-wait-spinner').classList.add("d-none");
                    return;

                }else{
                    document.getElementById('eventLog-count').innerText = eventLog.length;
                    document.getElementById('eventLog-count').classList.remove("d-none");
                }

                i = 0;

                eventLog.forEach(function (element){

                    var row = table.insertRow();
                    var colNumber = row.insertCell();
                    var colTime = row.insertCell();
                    var colLevel = row.insertCell();
                    var colText = row.insertCell();

                    colNumber.innerText = i + 1;

                    colTime.innerText = new Date(element.time*1000).toLocaleString();

                    switch(element.level){
                        case "info":
                            colLevel.innerHTML = `<span class="badge bg-primary">Information</span>`;
                            break;

                        case "notify":
                            colLevel.innerHTML = `<span class="badge bg-warning">Notification</span>`;
                            break;

                        case "error":
                            colLevel.innerHTML = `<span class="badge bg-danger">Error</span>`;
                            break;

                        default:
                            colLevel.innerHTML = `<span class="badge bg-dark">` + element.level + `</span>`;
                            break;

                    }

                    colText.innerText = element.text;

                    i++;
                });

                document.getElementById('eventLog-tab-table').classList.remove("d-none");
                document.getElementById('eventLog-tab-wait-spinner').classList.add("d-none");
            }


            async function getErrorLog(){

                errorLog = [];

                document.getElementById('errorLog-tab-table').classList.add("d-none");
                document.getElementById('errorLog-tab-wait-spinner').classList.remove("d-none");

                try{
                    let response = await fetch(api_root + "/errors", { signal: AbortSignal.timeout(api_timeout) });

                    if (response.ok) {
                        errorLog = await response.json();
                        drawErrorLog()
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("errorLog-tab");
                        errorHandler_get_div("errorLog-tab-pane");
                        createErrorToast("Unable to get Error Log", "Timeout");
                    } else {
                        prependWarningLabel("errorLog-tab");
                        errorHandler_get_div("errorLog-tab-pane");
                        createErrorToast("Unable to get Error Log", err);
                    }
                }
            }


            function drawErrorLog(){

                var table = document.getElementById('errorLog-tab-table-data');

                table.innerHTML = "";

                document.getElementById('errorLog-count').innerText = errorLog.length;

                if(errorLog.length == 0){
                    document.getElementById('errorLog-tab-wait-spinner').classList.add("d-none");
                    document.getElementById('errorLog-tab-table').classList.add("d-none");
                    document.getElementById('errorLog-no-errors').classList.remove("d-none");
                    document.getElementById('errorLog-count').classList.add("d-none");

                    return;
                }

                i = 0;

                errorLog.forEach(function (element){

                    var row = table.insertRow();
                    var colNumber = row.insertCell();
                    var colText = row.insertCell();

                    colNumber.innerText = i + 1;
                    colText.innerText = element.text;

                    i++;
                });

                document.getElementById('errorLog-count').classList.remove("d-none");
                document.getElementById('errorLog-no-errors').classList.add("d-none");
                document.getElementById('errorLog-tab-table').classList.remove("d-none");
                document.getElementById('errorLog-tab-wait-spinner').classList.add("d-none");
            }


            function drawApplicationVersion(){

                if(application_version == {}){
                    return;
                }

                document.getElementById("about-hardware-product-hex").innerText = application_version['product_hex'];
                document.getElementById("about-application-version").innerText = application_version['application'];
            }


            async function getUIVersion(){

                try{
                    let response = await fetch(ui_root + "/version", { signal: AbortSignal.timeout(api_timeout) });

                    if (response.ok) {
                        ui_version = await response.json();
                        drawUIVersion();
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("about-tab");
                        errorHandler_get_inline("about-ui-version");
                        createErrorToast("Unable to get UI version", "Timeout");
                    } else {
                        prependWarningLabel("about-tab");
                        errorHandler_get_inline("about-ui-version");
                        createErrorToast("Unable to get UI version", err);
                    }
                }             
            }


            function drawUIVersion(){
                document.getElementById("about-ui-version").innerText = ui_version['ui'];
            }


            async function getCertificates(){

                try{
                    let response = await fetch("/certs", { signal: AbortSignal.timeout(api_timeout) });

                    if (response.ok) {
                        certificates = await response.json();
                        drawCertificates();
                    } else {
                        throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }

                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("certificates-tab");
                        createErrorToast("Unable to get certificates", "Timeout");
                    } else {
                        prependWarningLabel("certificates-tab");
                        createErrorToast("Unable to get certificates", err);
                    }
                }             
            }


            function drawCertificates(){

                var table = document.getElementById('certificates-tab-table-data');
                table.innerHTML = "";

                if(certificates == []){
                    return;
                }

                while(document.getElementById('ota-update-service-certificate').length > 0){
                    document.getElementById('ota-update-service-certificate').remove(0);
                }

                var updateServiceCertificateNoneOption = document.createElement("option");
                updateServiceCertificateNoneOption.value = "";
                updateServiceCertificateNoneOption.text = "(None)";
                document.getElementById('ota-update-service-certificate').add(updateServiceCertificateNoneOption);


                while(document.getElementById('ota-update-force-certificate').length > 0){
                    document.getElementById('ota-update-force-certificate').remove(0);
                }

                var forceCertificateNoneOption = document.createElement("option");
                forceCertificateNoneOption.value = "";
                forceCertificateNoneOption.text = "(None)";
                document.getElementById('ota-update-force-certificate').add(forceCertificateNoneOption);

                certificates.forEach(function (element){
                    var row = table.insertRow();

                    var colFile = row.insertCell();
                    var colSize = row.insertCell();
                    var colOperation = row.insertCell();

                    colFile.innerHTML = "<a href=\"#\" onClick=\"showCertificateContents('" + element.file + "');\">" + element.file + "</a>";
                    colSize.innerHTML = bytesToSize(element.size);

                    colOperation.innerHTML = "<button type=\"button\" class=\"btn btn-outline-danger d-inline-flex p-2\" id=\"certificate-delete-button-" + element.file.replace("/", "_").replace(".", "_") + "\" title=\"Delete\" onclick=\"certificate_delete('" + element.file + "');\">\
                                <span class=\"spinner-border spinner-border-sm d-none\" role=\"status\" aria-hidden=\"true\" id=\"certificate-delete-button-spinner-" + element.file.replace("/", "_").replace(".", "_") + "\"></span> \
                                <span><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-arrow-repeat\" viewBox=\"0 0 16 16\" id=\"certificate-delete-button-icon-" + element.file.replace("/", "_").replace(".", "_") + "\">\
                                    <path d=\"M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146zm-6.106 4.5L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z\"/>\
                                </svg> Delete</span></button>";

                    var updateServiceOption = document.createElement("option");
                    var forceServiceOption = document.createElement("option");
                    updateServiceOption.value = element.file;
                    updateServiceOption.text = element.file;
                    forceServiceOption.value = element.file;
                    forceServiceOption.text = element.file;

                    document.getElementById('ota-update-service-certificate').add(updateServiceOption);
                    document.getElementById('ota-update-force-certificate').add(forceServiceOption);
                });

                updateServiceCertificateNoneOption.selected = true;
                forceCertificateNoneOption.selected = true;

                document.getElementById('certificates-tab-content').classList.remove("d-none");
                document.getElementById('certificates-tab-wait-spinner').classList.add("d-none");
            }


            async function certificate_delete(file){

                try{

                    if(!confirm("Are you sure you wish to delete " + file + "?")){
                        return;
                    }

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    var button = document.getElementById("certificate-delete-button-" + file.replace("/", "_").replace(".", "_"));
                    var spinner = document.getElementById("certificate-delete-button-spinner-" + file.replace("/", "_").replace(".", "_"));
                    var icon = document.getElementById("certificate-delete-button-icon-" + file.replace("/", "_").replace(".", "_"));

                    button.disabled = true;
                    spinner.classList.remove("d-none");
                    icon.classList.add("d-none");

                    let response = await fetch("/certs/" + file, {
                        signal: AbortSignal.timeout(api_timeout), 
                        method: 'DELETE',
                        headers: {
                            "x-visual-token":visual_token
                        }
                    });

                    switch(response.status){
                        case 204:
                            createSuccessToast("Success", "Certificate has been deleted");
                            getCertificates();
                            break;

                        case 401:
                            createErrorToast("Unable to delete certificate", "Authentication failed");
                            button.disabled = false;
                            break;

                        default:
                            throw new Error("Unable to delete certificate " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    getCertificates();                   
                    if (err.name === "AbortError") {
                        createErrorToast("Unable to delete certificate", "Timeout");
                    } else {
                        createErrorToast("Unable to delete certificate", err);
                    }
                }
            }


            function certificateUploadButtonToggle(){

                var fileSelector = document.getElementById("certificate-upload-file-selector");
                var button = document.getElementById("certificate-upload-button");

                if(fileSelector.files.length == 1){
                    button.disabled = false;
                }else{
                    button.disabled = true;
                }
            }


            function certificateFileSelectorClear(){

                var fileSelector = document.getElementById("certificate-upload-file-selector");
                fileSelector.value = null;

                certificateUploadButtonToggle();
            }


            async function certificate_post(){

                try{

                    var fileSelector = document.getElementById("certificate-upload-file-selector");

                    if(fileSelector.files.length != 1){
                        createErrorToast("Choose a File", "No file was selected to be uploaded");
                        certificateUploadButtonToggle();
                        return;
                    }

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    var button = document.getElementById("certificate-upload-button");
                    var spinner = document.getElementById("certificate-upload-button-spinner");
                    var icon = document.getElementById("certificate-upload-button-icon");

                    button.disabled = true;
                    fileSelector.disabled = true;
                    spinner.classList.remove("d-none");
                    icon.classList.add("d-none");

                    const formData = new FormData();

                    formData.append("file", fileSelector.files[0])

                    let response = await fetch("/certs", {
                        signal: AbortSignal.timeout(api_timeout),
                        method: "POST",
                        body: formData,                     
                        headers: {
                            "x-visual-token":visual_token
                        }
                    });

                    switch(response.status){
                        case 201:
                            createSuccessToast("Success", "Certificate has been uploaded");
                            getCertificates();
                            break;

                        case 401:
                            visual_token = "";
                            createErrorToast("Unable to upload certificate", "Authentication failed");
                            button.disabled = false;
                            break;

                        default:
                            throw new Error("Unable to upload certificate " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    getCertificates();                   
                    if (err.name === "AbortError") {
                        createErrorToast("Unable to upload certificate", "Timeout");
                    } else {
                        createErrorToast("Unable to upload certificate", err);
                    }
                }

                button.disabled = false;
                fileSelector.disabled = false;
                spinner.classList.add("d-none");
                icon.classList.remove("d-none");
                certificateFileSelectorClear();
            }


            async function showCertificateContents(filename){

                var certificateModal = new bootstrap.Modal(document.getElementById('certificate-modal'));
               
                var title = document.getElementById('certificate-modal-title');
                var body = document.getElementById('certificate-modal-code');

                document.getElementById('certificate-modal-wait-spinner').classList.remove("d-none");
                document.getElementById('certificate-modal-code-fail').classList.add("d-none");
                document.getElementById('certificate-modal-code').classList.add("d-none");

                title.innerText = "Certificate contents for " + filename;

                certificateModal.show();

                try{

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    let response = await fetch("/certs/" + filename, { 
                        signal: AbortSignal.timeout(api_timeout),
                        method: 'GET',
                        headers: {
                            "x-visual-token":visual_token
                        }
                    });
                    
                    switch(response.status){
                        case 200:
                            body.innerText = await response.text();
                            document.getElementById('certificate-modal-wait-spinner').classList.add("d-none");
                            document.getElementById('certificate-modal-code').classList.remove("d-none");
                            break;

                        default:
                            throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){

                    document.getElementById('certificate-modal-code-fail').classList.remove("d-none");
                    document.getElementById('certificate-modal-wait-spinner').classList.add("d-none"); 

                    if (err.name === "AbortError") {
                        createErrorToast("Unable to get certificate contents", "Timeout");
                    } else {
                        createErrorToast("Unable to get certificate contents", err);
                    }
                }         
            }


            async function getOtaUpdate(){

                try{
                    let response = await fetch(api_root + "/ota", { signal: AbortSignal.timeout(api_timeout) });

                    switch(response.status){
                        case 200:
                            otaConfig = await response.json();
                            drawOtaConfig();
                            break;

                        case 404:
                            otaConfig = null
                            document.getElementById('updates-tab-wait-spinner').classList.add("d-none");
                            document.getElementById('updates-tab-content').classList.remove("d-none");
                            break;

                        default:
                            throw new Error("Unable to get " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    if (err.name === "AbortError") {
                        prependWarningLabel("updates-tab");
                        errorHandler_get_div("updates-tab-content");
                        document.getElementById('updates-tab-wait-spinner').classList.add("d-none");
                        document.getElementById('updates-tab-content').classList.remove("d-none");
                        createErrorToast("Unable to get OTA configuration", "Timeout");
                        
                    } else {
                        prependWarningLabel("updates-tab");
                        errorHandler_get_div("updates-tab-content");
                        createErrorToast("Unable to get OTA configuration", err);
                        errorHandler_get_div("updates-tab-content");
                        document.getElementById('updates-tab-wait-spinner').classList.add("d-none");
                        document.getElementById('updates-tab-content').classList.remove("d-none");
                    }
                } 
            }

            
            function drawOtaConfig(){

                document.getElementById('updates-tab-content').classList.remove("d-none");
                document.getElementById('updates-tab-wait-spinner').classList.add("d-none");
                
                if(Object.keys(otaConfig).length == 0){
                    document.getElementById('ota-update-service-url').value = "";
                    document.getElementById('ota-update-service-certificate').value = "";
                    return;
                }

                document.getElementById('ota-update-service-delete-button').disabled = false;
                document.getElementById('ota-update-service-url').value = otaConfig.url;
                document.getElementById('ota-update-service-save-button').disabled = true;

                certificateExists = false;

                for(i=0; i < document.getElementById('ota-update-service-certificate').length; i++){

                    if(document.getElementById('ota-update-service-certificate').options[i].value == otaConfig.certificate){
                        certificateExists = true;
                    }
                };

                document.getElementById('ota-update-service-certificate').value = otaConfig.certificate;

                if(!certificateExists){
                    createErrorToast("OTA update service", "OTA update service certificate \"" + otaConfig.certificate + "\" does not exist");
                }
            }


            async function postOtaUpdate(){

                try{

                    const transportPattern = /(^https?:\/\/)/;

                    if(!transportPattern.test(document.getElementById("ota-update-service-url").value)){
                        throw new Error("URL must begin with http:// or https://");
                    }

                    const urlPattern = /(https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)?[a-zA-Z]{2,}(\.[a-zA-Z]{2,})(\.[a-zA-Z]{2,})?\/[a-zA-Z0-9]{2,}|((https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)?[a-zA-Z]{2,}(\.[a-zA-Z]{2,})(\.[a-zA-Z]{2,})?)|(https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)?[a-zA-Z0-9]{2,}\.[a-zA-Z0-9]{2,}\.[a-zA-Z0-9]{2,}(\.[a-zA-Z0-9]{2,})?/g;

                    if(!urlPattern.test(document.getElementById("ota-update-service-url").value)){
                        throw new Error("URL is not valid");
                    }

                    if(document.getElementById("ota-update-service-url").value.startsWith("https://") && document.getElementById("ota-update-service-certificate").value == ""){
                        throw new Error("Certificate is required for https://");
                    }

                    payload = {}

                    payload['url'] = document.getElementById("ota-update-service-url").value;
                    if(document.getElementById("ota-update-service-certificate").value != ""){
                        payload['certificate'] = document.getElementById("ota-update-service-certificate").value;
                    }

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    document.getElementById("ota-update-service-save-button-spinner").classList.remove("d-none");
                    document.getElementById("ota-update-service-save-button-icon").classList.add("d-none");
                    document.getElementById("ota-update-service-save-button").disabled = true;

                    let response = await fetch(api_root + "/ota", {
                        signal: AbortSignal.timeout(api_timeout),
                        method: "POST",
                        body:JSON.stringify(payload),                     
                        headers: {
                            "content-type":"application/json",
                            "x-visual-token":visual_token
                        }
                    });

                    switch(response.status){
                        case 201:
                            createSuccessToast("Success", "OTA update service configured");
                            document.getElementById("ota-update-service-delete-button").disabled = false;
                            break;

                        case 401:
                            visual_token = "";
                            createErrorToast("Unable to save OTA update", "Authentication failed");
                            document.getElementById("ota-update-service-save-button").disabled = false;
                            break;

                        default:
                            throw new Error("Unable to save OTA update " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){            
                    document.getElementById("ota-update-service-save-button").disabled = false;     
                    if (err.name === "AbortError") {
                        createErrorToast("Unable to save OTA update", "Timeout");
                    } else {
                        createErrorToast("Unable to save OTA update", err);
                    }
                }

                document.getElementById("ota-update-service-save-button-spinner").classList.add("d-none");
                document.getElementById("ota-update-service-save-button-icon").classList.remove("d-none");
            }


            async function deleteOtaUpdate(){

                try{

                    if(!confirm("Are you sure you wish to delete the OTA update service configuration?")){
                        return;
                    }

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    document.getElementById("ota-update-service-delete-button-spinner").classList.remove("d-none");
                    document.getElementById("ota-update-service-delete-button-icon").classList.add("d-none");
                    document.getElementById("ota-update-service-delete-button").disabled = true;

                    let response = await fetch(api_root + "/ota", {
                        signal: AbortSignal.timeout(api_timeout), 
                        method: 'DELETE',
                        headers: {
                            "x-visual-token":visual_token
                        }
                    });

                    switch(response.status){
                        case 204:
                            otaConfig = {};
                            await getCertificates();
                            drawOtaConfig();
                            createSuccessToast("Success", "OTA update service configuration has been deleted");
                            document.getElementById("ota-update-service-delete-button-spinner").classList.add("d-none");
                            document.getElementById("ota-update-service-delete-button-icon").classList.remove("d-none");
                            document.getElementById("ota-update-service-save-button").disabled = false;
                            break;

                        case 401:
                            createErrorToast("Unable to delete OTA update service configuration", "Authentication failed");
                            document.getElementById("ota-update-service-delete-button-spinner").classList.add("d-none");
                            document.getElementById("ota-update-service-delete-button-icon").classList.remove("d-none");
                            document.getElementById("ota-update-service-delete-button").disabled = false;
                            break;

                        default:
                            throw new Error("Unable to delete OTA update service configuration " + response.url + " (" + response.status + ")");
                    }
                }
                catch(err){
                    document.getElementById("ota-update-service-delete-button").disabled = false;   
                    document.getElementById("ota-update-service-delete-button-spinner").classList.add("d-none");
                    document.getElementById("ota-update-service-delete-button-icon").classList.remove("d-none");

                    if (err.name === "AbortError") {
                        createErrorToast("Unable to delete OTA update service configuration", "Timeout");
                    } else {
                        createErrorToast("Unable to delete OTA update service configuration", err);
                    }
                }
            }



            async function postForceOTAUpdate(){

                try{

                    const transportPattern = /(^https?:\/\/)/;

                    if(!transportPattern.test(document.getElementById("ota-update-force-url").value)){
                        throw new Error("URL must begin with http:// or https://");
                    }

                    const urlPattern = /(https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)?[a-zA-Z]{2,}(\.[a-zA-Z]{2,})(\.[a-zA-Z]{2,})?\/[a-zA-Z0-9]{2,}|((https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)?[a-zA-Z]{2,}(\.[a-zA-Z]{2,})(\.[a-zA-Z]{2,})?)|(https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)?[a-zA-Z0-9]{2,}\.[a-zA-Z0-9]{2,}\.[a-zA-Z0-9]{2,}(\.[a-zA-Z0-9]{2,})?/g;

                    if(!urlPattern.test(document.getElementById("ota-update-force-url").value)){
                        throw new Error("URL is not valid");
                    }

                    if(document.getElementById("ota-update-force-url").value.startsWith("https://") && document.getElementById("ota-update-force-certificate").value == ""){
                        throw new Error("Certificate is required for https://");
                    }

                    payload = {}

                    payload['url'] = document.getElementById("ota-update-force-url").value;
                    if(document.getElementById("ota-update-force-certificate").value != ""){
                        payload['certificate'] = document.getElementById("ota-update-force-certificate").value;
                    }

                    let authenticated = await authenticate();

                    if(!authenticated){
                        return;
                    }

                    document.getElementById("ota-update-now-button-spinner").classList.remove("d-none");
                    document.getElementById("ota-update-now-button-icon").classList.add("d-none");
                    document.getElementById("ota-update-now-button").disabled = true;

                    let response = await fetch(api_root + "/ota/" + document.getElementById("ota-update-force-type").value, {
                        signal: AbortSignal.timeout(api_timeout),
                        method: "POST",
                        body:JSON.stringify(payload),                     
                        headers: {
                            "content-type":"application/json",
                            "x-visual-token":visual_token
                        }
                    });

                    document.getElementById("ota-update-now-button").disabled = false;

                    switch(response.status){
                        case 202:
                            createSuccessToast("Request accepted", "OTA update will begin shortly");
                            break;

                        case 401:
                            visual_token = "";
                            createErrorToast("Unable to force OTA update", "Authentication failed");
                            break;

                        default:
                            response_text = await response.text();
                            throw new Error("Unable to force OTA update " + response.url + " (" + response.status + ") " + response_text);
                    }
                }
                catch(err){
                    document.getElementById("ota-update-now-button").disabled = false;     
                    if (err.name === "AbortError") {
                        createErrorToast("Unable to force OTA update", "Timeout");
                    } else {
                        createErrorToast("Unable to force OTA update", err);
                    }
                }

                document.getElementById("ota-update-now-button-spinner").classList.add("d-none");
                document.getElementById("ota-update-now-button-icon").classList.remove("d-none");

            }




            function createErrorToast(title, message){

                var template = document.getElementById('toast-element-error');
                var toaster = template.cloneNode(true);
                
                toaster.querySelector('.toast-header').innerHTML = title;
                toaster.querySelector('.toast-body').innerHTML = message;

                var visibleToast = new bootstrap.Toast(toaster, {'autohide': false});

                visibleToast.show();
                template.parentNode.appendChild(toaster);

            }


            function createSuccessToast(title, message){

                var template = document.getElementById('toast-element-success');
                var toaster = template.cloneNode(true);

                toaster.querySelector('.toast-header').innerHTML = title;
                toaster.querySelector('.toast-body').innerHTML = message;

                var visibleToast = new bootstrap.Toast(toaster, {'autohide': true});

                visibleToast.show();
                template.parentNode.appendChild(toaster);

            }


            function generateRandomString(length) {
                const characters ='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                const charactersLength = characters.length;
                for ( let i = 0; i < length; i++ ) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }

                return result;
            }

        </script>
    </head>
    <body>

        <!-- Toast Messages -->
        <div class="toast-container end-0 top-0 p-3">
            <div class="toast align-items-center border-0" id="toast-element-error" role="alert">
                
                    <div class="toast-header text-bg-danger"></div>
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>

            <div class="toast align-items-center border-0" id="toast-element-success" role="alert">
                
                <div class="toast-header text-bg-success"></div>
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>


        <!-- Modals -->
        <div class="modal" tabindex="-1" id="certificate-modal">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="certificate-modal-title"></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="certificate-modal-body">
                    <div class="d-flex justify-content-center align-items-center mt-2" id="certificate-modal-wait-spinner">
                        <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                            <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                        </div>
                    </div>

                    <div id="certificate-modal-code-fail" class="d-none"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-exclamation-triangle-fill text-danger" width="20" height="20" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg> Unable to retrieve certificate contents.</div>

                    <code id="certificate-modal-code" class="d-none text-nowrap"></code>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>


        <!-- Naviation Menu -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <span class="navbar-brand">Hardware Configuration</span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" aria-current="page" href="#" id="mcu-tab" data-bs-toggle="tab" data-bs-target="#mcu-tab-pane" type="button" role="tab" aria-controls="mcu-tab-pane" aria-selected="true">MCU</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="network-tab" data-bs-toggle="tab" data-bs-target="#network-tab-pane" type="button" role="tab" aria-controls="network-tab-pane" aria-selected="false">Network</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="identification-tab" data-bs-toggle="tab" data-bs-target="#identification-tab-pane" type="button" role="tab" aria-controls="identification-tab-pane" aria-selected="false">Identification</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="partition-table-tab" data-bs-toggle="tab" data-bs-target="#partition-table-tab-pane" type="button" role="tab" aria-controls="partition-table-tab-pane" aria-selected="false">Partition Table</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="peripherals-tab" data-bs-toggle="tab" data-bs-target="#peripherals-tab-pane" type="button" role="tab" aria-controls="peripherals-tab-pane" aria-selected="false">Peripherals</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="certificates-tab" data-bs-toggle="tab" data-bs-target="#certificates-tab-pane" type="button" role="tab" aria-controls="certificates-tab-pane" aria-selected="false">Certificates</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="updates-tab" data-bs-toggle="tab" data-bs-target="#updates-tab-pane" type="button" role="tab" aria-controls="updates-tab-pane" aria-selected="false">Updates</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link text-nowrap" aria-current="page" href="#" id="eventLog-tab" data-bs-toggle="tab" data-bs-target="#eventLog-tab-pane" type="button" role="tab" aria-controls="eventLog-tab-pane" aria-selected="false">Event Log<span class="translate-middle badge rounded-pill text-dark bg-light d-none" style="float:right;margin-left:20px;" id="eventLog-count"></span></a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="errorLog-tab" data-bs-toggle="tab" data-bs-target="#errorLog-tab-pane" type="button" role="tab" aria-controls="errorLog-tab-pane" aria-selected="false">Error Log<span class="translate-middle badge rounded-pill bg-danger d-none" style="float:right;margin-left:20px;" id="errorLog-count"></span></a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" aria-current="page" href="#" id="about-tab" data-bs-toggle="tab" data-bs-target="#about-tab-pane" type="button" role="tab" aria-controls="about-tab-pane" aria-selected="false">About</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>


        <!-- Content -->
        <div class="tab-content container-fluid" id="content">


            <!-- Hardware -->
            <div class="tab-pane fade show active" id="mcu-tab-pane" role="tabpanel" aria-labelledby="mcu-tab" tabindex="0">                    
                <strong>Chip Model:</strong> <span id="chip_model"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span><br>
                <strong>Revision:</strong> <span id="chip_revision"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span><br>
                <strong>Flash Chip Size:</strong> <span id="flash_chip_size"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span><br>
                <strong>Boot Time:</strong> <span id="boot_time"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span>
            </div>


            <!-- Network -->
            <div class="tab-pane fade" id="network-tab-pane" role="tabpanel" aria-labelledby="network-tab" tabindex="0">

                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="network-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>

                <!--Data Table-->
                <div class="table-responsive d-none" id="network-tab-table">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                            <th scope="col">Interface</th>
                            <th scope="col">MAC Address</th>
                            </tr>
                        </thead>
                        <tbody id="network-tab-table-data"></div>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- Identification -->
            <div class="tab-pane fade" id="identification-tab-pane" role="tabpanel" aria-labelledby="identification-tab" tabindex="0">


                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="identification-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>

                <!--Input Form-->
                <div id="identification-tab-content" class="d-none">
                    <div id="identification-alert" class="alert alert-warning mt-2 d-none" role="alert">Controller has been previously configured.</div>
                    
                    <div class="row mt-2">
                        <div class="input-group mb-3">
                            <span class="input-group-text">Device UUID</span>
                            <input type="text" class="form-control" id="uuid">
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-group mb-3">
                            <span class="input-group-text">Product ID</span>
                            <select class="form-select" id="product_id">
                            </select>
                            <div class="input-group-append"><div class="input-group-append">
                                <span class="input-group-text" onclick="product_id_toggle();">
                                    <i id="identification-product_id-unlock">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-identification-product_id-unlock-fill" viewBox="0 0 16 16">
                                            <path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/>
                                        </svg>
                                    </i>
                                    <i id="identification-product_id-lock" class="d-none">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill" viewBox="0 0 16 16">
                                            <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                                        </svg>
                                    </i>
                                </span>
                            </div></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-group mb-3">
                                <span class="input-group-text" id="identification-key">Key</span>
                                <input type="password" class="form-control" id="key">
                                <div class="input-group-append">
                                    <span class="input-group-text" onclick="key_password_toggle();">
                                    <i id="identification-key-show_eye"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16">
                                        <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/>
                                        <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/>
                                    </svg></i>
                                    <i class="d-none" id="identification-key-hide_eye"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                                        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                                    </svg></i>
                                    </span>
                                </div>
                        </div>
                    </div>
                    <div class="row g-3 d-flex gap-2 mb-3">
                        <div class="col-auto">
                            <button type="button" class="btn btn-primary" title="Save" id="identification-save-button" onclick="postIdentification();">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="identification-save-button-spinner"></span>
                                <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16" id="identification-save-button-icon">
                                    <path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"/></svg> Save</span></button>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-outline-danger" id="identification-delete-button" title="Delete" onclick="deleteIdentification();">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="identification-delete-button-spinner"></span>
                                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16" id="identification-delete-button-icon">
                                    <path d="M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146zm-6.106 4.5L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"/>
                                </svg> Delete</span></button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Partition Table -->
            <div class="tab-pane fade" id="partition-table-tab-pane" role="tabpanel" aria-labelledby="partition-table-tab" tabindex="0">
                
                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="partition-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>


                <!--Data Table-->
                <div class="table-responsive" id="partition-tab-table" class="d-none">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Type</th>
                                <th scope="col">Subtype</th>
                                <th scope="col">Address</th>
                                <th scope="col">Size</th>
                                <th scope="col">Label</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody id="partition-tab-table-data">
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- Peripherals -->
            <div class="tab-pane fade" id="peripherals-tab-pane" role="tabpanel" aria-labelledby="peripherals-tab" tabindex="0">

                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="peripheral-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped d-none" id="peripheral-tab-table">
                        <thead>
                        <tr>
                            <th scope="col">Address</th>
                            <th scope="col">Type</th>
                            <th scope="col">Status</th>
                        </tr>
                        </thead>
                        <tbody id="peripheral-tab-table-data"></tbody>
                    </table>
                </div>
            </div>


            <!-- Event Log -->
            <div class="tab-pane fade" id="eventLog-tab-pane" role="tabpanel" aria-labelledby="eventLog-tab" tabindex="0">

                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="eventLog-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped d-none" id="eventLog-tab-table">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Time</th>
                            <th scope="col">Level</th>
                            <th scope="col">Text</th>
                        </tr>
                        </thead>
                        <tbody id="eventLog-tab-table-data"></tbody>
                    </table>
                </div>
            </div>


            <!-- Certificates -->
            <div class="tab-pane fade" id="certificates-tab-pane" role="tabpanel" aria-labelledby="certificates-tab" tabindex="0">


                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="certificates-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>

                <!--Content-->
                <div id="certificates-tab-content" class="d-none">
                    <br>
                        <div class="input-group" id="certificates-upload">
                            <input type="file" class="form-control" aria-label="Upload" name="file" id="certificate-upload-file-selector" onchange="certificateUploadButtonToggle();">
                            <button class="btn btn-primary" type="button" disabled="true" id="certificate-upload-button" onclick="certificate_post();">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="certificate-upload-button-spinner"></span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16" id="certificate-upload-button-icon">
                                    <path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"/></svg> Upload</button>
                        </div>
                    <!--</form>-->
                    <hr>                  
                    <div class="table-responsive" id="certificates-tab-table">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th scope="col">Filename</th>
                                <th scope="col">Size</th>
                                <th scope="col">Operation</th>
                            </tr>
                            </thead>
                            <tbody id="certificates-tab-table-data"></tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Updates -->
            <div class="tab-pane fade" id="updates-tab-pane" role="tabpanel" aria-labelledby="updates-tab" tabindex="0">


                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="updates-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>

                <!--Input Forms-->
                <div id="updates-tab-content" class="d-none">
                    <div class="row mt-2">
                        <h3>OTA Update Service</h3>
                        <div class="input-group mb-3">
                            <label class="input-group-text">URL</label>
                            <input type="text" class="form-control" id="ota-update-service-url" required>
                            <label class="input-group-text">Certificate</label>
                            <select class="form-select" id="ota-update-service-certificate"><option value="">(None)</option></select>
                            <button type="button" class="btn btn-primary" title="Save" id="ota-update-service-save-button" onclick="postOtaUpdate();">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="ota-update-service-save-button-spinner"></span>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16" id="ota-update-service-save-button-icon">
                                    <path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"/></svg> Save
                                </span>
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="ota-update-service-delete-button" title="Delete" onclick="deleteOtaUpdate();" disabled>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="ota-update-service-delete-button-spinner"></span>
                                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16" id="ota-update-service-delete-button-icon">
                                    <path d="M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146zm-6.106 4.5L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"/>
                                </svg> Delete</span></button>
                        </div>
                    </div>
                </div>
                <div id="updates-tab-force-update" class="row mt-5">
                    <h3>Force OTA Update</h3>
                    <div class="input-group mb-3">
                        <label class="input-group-text">URL</label>
                        <input type="text" class="form-control" id="ota-update-force-url">
                        <label class="input-group-text">Certificate</label>
                        <select class="form-select" id="ota-update-force-certificate"><option value="">(None)</option></select>
                        <label class="input-group-text">Type</label>
                        <select class="form-select" id="ota-update-force-type">
                            <option value="app" selected>Application</option>
                            <option value="spiffs">SPIFFS</option>
                        </select>
                        <button type="button" class="btn btn-warning" title="Update Now" id="ota-update-now-button" onclick="postForceOTAUpdate();">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="ota-update-now-button-spinner"></span>
                            <span><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" id="ota-update-now-button-icon"><path d="M480-120q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-480q0-75 28.5-140.5t77-114q48.5-48.5 114-77T480-840q82 0 155.5 35T760-706v-94h80v240H600v-80h110q-41-56-101-88t-129-32q-117 0-198.5 81.5T200-480q0 117 81.5 198.5T480-200q105 0 183.5-68T756-440h82q-15 137-117.5 228.5T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z"/></svg>
                                Update Now</span>
                        </button>
                    </div>
                </div>

            </div>


            <!-- Error Log -->
            <div class="tab-pane fade" id="errorLog-tab-pane" role="tabpanel" aria-labelledby="errorLog-tab" tabindex="0">

                <!--Wait Spinner-->
                <div class="d-flex justify-content-center align-items-center mt-2" id="errorLog-tab-wait-spinner">
                    <div class="rounded d-flex justify-content-center align-items-center" style="background-color: rgb(0,0,0,0.1); width: 50px; height: 50px;">
                        <div class="spinner-border spinner-border align-middle text-secondary" role="status" ><span class="visually-hidden">Loading...</span></div>
                    </div>
                </div>

                <div id="errorLog-no-errors" class="d-none">No errors to display.</div>

                <div class="table-responsive">
                    <table class="table table-striped d-none" id="errorLog-tab-table">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Text</th>
                        </tr>
                        </thead>
                        <tbody id="errorLog-tab-table-data"></tbody>
                    </table>
                </div>
            </div>


            <!-- Abount -->
            <div class="tab-pane fade" id="about-tab-pane" role="tabpanel" aria-labelledby="about-tab" tabindex="0">
                    <strong>UI Version:</strong> <span id="about-ui-version"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span><br>
                    <strong>Hardware Product Hex:</strong> <span id="about-hardware-product-hex"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span><br>
                    <strong>Application Version:</strong> <span id="about-application-version"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></span><br>
                    <small>&copy; <span id="copyright"></span>, P5 Software, LLC</small>
                <div class="mt-4">
                    <h4>Included Third Party Libraries</h4>
                    This application uses third party libraries.  See <a href="https://github.com/BrentIO/FireFly-Controller" target="_blank">GitHub</a> for the complete list.
                </div>
            </div>
        </div>
    </body>
</html>